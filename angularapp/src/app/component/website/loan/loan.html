<div class="apply-loan">
  <div class="form-header">
    <h1 class="form-title">Apply Loan</h1>
  </div>
<div class="back-container">
  <button class="back-button" (click)="goBack()">‚ÜêDashboard</button>
</div>

  <!-- CIBIL Information Card -->
  <div class="cibil-info-card" *ngIf="cibilInfo.cibilScore > 0 || cibilInfo.loading || cibilInfo.error">
    <h3>üìä Credit Information</h3>
    <div *ngIf="cibilInfo.loading" class="loading-cibil">
      <p>Checking CIBIL score...</p>
    </div>
    <div *ngIf="cibilInfo.error && !cibilInfo.loading" class="cibil-error">
      <p>‚ùå {{ cibilInfo.error }}</p>
    </div>
    <div *ngIf="!cibilInfo.loading && !cibilInfo.error && cibilInfo.cibilScore > 0" class="cibil-details">
      <div class="cibil-grid">
        <div class="cibil-item">
          <span class="cibil-label">CIBIL Score:</span>
          <span class="cibil-value score" [ngClass]="{
            'excellent': cibilInfo.cibilScore >= 750,
            'good': cibilInfo.cibilScore >= 700 && cibilInfo.cibilScore < 750,
            'fair': cibilInfo.cibilScore >= 650 && cibilInfo.cibilScore < 700,
            'average': cibilInfo.cibilScore >= 600 && cibilInfo.cibilScore < 650,
            'poor': cibilInfo.cibilScore < 600
          }">{{ cibilInfo.cibilScore }}</span>
          <span class="cibil-category">({{ cibilInfo.scoreCategory }})</span>
        </div>
        <div class="cibil-item">
          <span class="cibil-label">Interest Rate:</span>
          <span class="cibil-value">{{ cibilInfo.interestRate }}% p.a.</span>
        </div>
        <div class="cibil-item">
          <span class="cibil-label">Available Credit Limit:</span>
          <span class="cibil-value limit">‚Çπ{{ cibilInfo.creditLimit | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>
  </div>

  <form (ngSubmit)="submitLoan()" #loanFormRef="ngForm">
    <div class="input-group">
      <label class="input-label">PAN Card Number <span class="required">*</span></label>
      <div class="pan-input-container">
        <input
          type="text"
          class="input-field"
          placeholder="Enter PAN number"
          [(ngModel)]="loanForm.pan"
          name="pan"
          [readonly]="cibilInfo.cibilScore > 0"
          [class.readonly]="cibilInfo.cibilScore > 0"
          required
          maxlength="10"
          (blur)="loanForm.pan && loanForm.pan.trim() !== '' && checkCibilByPan(loanForm.pan)"
        />
        <button 
          type="button" 
          class="check-cibil-btn" 
          (click)="checkCibilByPan(loanForm.pan)"
          [disabled]="!loanForm.pan || cibilInfo.loading"
        >
          <span *ngIf="!cibilInfo.loading">‚úì Check CIBIL</span>
          <span *ngIf="cibilInfo.loading">‚è≥ Checking...</span>
        </button>
      </div>
      <small class="input-hint">PAN will be auto-filled from your account. Click "Check CIBIL" to verify.</small>
    </div>

    <div class="input-group">
      <label class="input-label">Loan Type</label>
      <select class="input-field" [(ngModel)]="loanForm.type" name="type" required (change)="onLoanTypeChange()">
        <option value="">Select Loan Type</option>
        <option value="Personal Loan">Personal Loan</option>
        <option value="Car Loan">Car Loan</option>
        <option value="Home Loan">Home Loan</option>
        <option value="Education Loan">Education Loan</option>
      </select>
    </div>

    <!-- Education Loan Form Section -->
    <div *ngIf="showEducationLoanForm" class="education-loan-form-section">
      <h3 class="section-title">üéì Education Loan Details</h3>
      
      <!-- Child/Student Information -->
      <div class="form-section">
        <h4>üë§ Child/Student Information (Age: 18-26 years)</h4>
        
        <!-- Neobank Account Selection -->
        <div class="input-group" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
          <label class="input-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input 
              type="checkbox" 
              [(ngModel)]="childHasNeobankAccount" 
              name="childHasNeobankAccount"
              (change)="onChildAccountOptionChange()"
              style="width: 20px; height: 20px; cursor: pointer;">
            <span style="font-weight: 600; color: #667eea;">Does the child have an account in NeoBank?</span>
          </label>
          <small class="input-hint" style="display: block; margin-top: 8px; color: #666;">
            If yes, enter Aadhar number and account number to auto-fill child details securely.
          </small>
        </div>

        <!-- Neobank Account Details (shown when checkbox is checked) -->
        <div *ngIf="childHasNeobankAccount" class="neobank-account-section" style="margin-bottom: 20px; padding: 15px; background: #e8f4f8; border-radius: 8px; border: 1px solid #b3d9e6;">
          <h5 style="margin-top: 0; color: #667eea; font-size: 16px;">üîê Verify Child's NeoBank Account</h5>
          <div class="form-row">
            <div class="input-group">
              <label class="input-label">Child's Aadhar Number <span class="required">*</span></label>
              <input 
                type="text" 
                class="input-field" 
                [(ngModel)]="childAccountAadhar" 
                name="childAccountAadhar" 
                placeholder="Enter 12-digit Aadhar number"
                maxlength="12"
                [disabled]="childAccountLoading || childAccountVerified"
                required>
            </div>
            <div class="input-group">
              <label class="input-label">Child's Account Number <span class="required">*</span></label>
              <input 
                type="text" 
                class="input-field" 
                [(ngModel)]="childAccountNumber" 
                name="childAccountNumber" 
                placeholder="Enter account number"
                [disabled]="childAccountLoading || childAccountVerified"
                required>
            </div>
          </div>
          <div class="form-row" style="margin-top: 10px;">
            <button 
              type="button" 
              class="check-cibil-btn" 
              (click)="fetchChildAccountDetails()"
              [disabled]="!childAccountAadhar || !childAccountNumber || childAccountLoading || childAccountVerified"
              style="margin-top: 0;">
              <span *ngIf="!childAccountLoading && !childAccountVerified">üîç Verify & Auto-Fill</span>
              <span *ngIf="childAccountLoading">‚è≥ Verifying...</span>
              <span *ngIf="childAccountVerified">‚úì Verified</span>
            </button>
            <button 
              type="button" 
              *ngIf="childAccountVerified"
              class="check-cibil-btn" 
              (click)="clearChildAccountDetails()"
              style="margin-left: 10px; background: #dc3545; margin-top: 0;">
              Clear
            </button>
          </div>
          <div *ngIf="childAccountError" class="error-message" style="margin-top: 10px; padding: 10px; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33;">
            ‚ùå {{ childAccountError }}
          </div>
          <div *ngIf="childAccountVerified && !childAccountError" class="success-message" style="margin-top: 10px; padding: 10px; background: #efe; border: 1px solid #cfc; border-radius: 4px; color: #3c3;">
            ‚úì Child account verified! Details have been auto-filled below.
          </div>
        </div>

        <div class="form-row">
          <div class="input-group">
            <label class="input-label">Child Name <span class="required">*</span></label>
            <input type="text" class="input-field" [(ngModel)]="educationLoanForm.childName" name="childName" 
                   [readonly]="childAccountVerified" [class.readonly]="childAccountVerified" required>
          </div>
          <div class="input-group">
            <label class="input-label">Date of Birth <span class="required">*</span></label>
            <input type="date" class="input-field" [(ngModel)]="educationLoanForm.childDateOfBirth" name="childDateOfBirth" 
                   required (change)="calculateChildAge()" [max]="getMaxDateOfBirth()" [min]="getMinDateOfBirth()"
                   [readonly]="childAccountVerified" [class.readonly]="childAccountVerified">
            <small class="input-hint" *ngIf="calculateChildAge() !== null">
              Age: {{ calculateChildAge() }} years
              <span *ngIf="!isValidChildAge()" class="error-text"> (Must be 18-26 years)</span>
            </small>
          </div>
        </div>
        <div class="input-group">
          <label class="input-label">Place of Birth <span class="required">*</span></label>
          <input type="text" class="input-field" [(ngModel)]="educationLoanForm.childPlaceOfBirth" name="childPlaceOfBirth" 
                 [readonly]="childAccountVerified" [class.readonly]="childAccountVerified" required>
        </div>
      </div>

      <!-- Education Details - 10th -->
      <div class="form-section">
        <h4>üìö 10th Standard Details</h4>
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">School Name <span class="required">*</span></label>
            <input type="text" class="input-field" [(ngModel)]="educationLoanForm.tenthSchoolName" name="tenthSchoolName" required>
          </div>
          <div class="input-group">
            <label class="input-label">Board <span class="required">*</span></label>
            <select class="input-field" [(ngModel)]="educationLoanForm.tenthBoard" name="tenthBoard" required>
              <option value="">Select Board</option>
              <option value="CBSE">CBSE</option>
              <option value="ICSE">ICSE</option>
              <option value="State Board">State Board</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">Passing Year <span class="required">*</span></label>
            <input type="number" class="input-field" [(ngModel)]="educationLoanForm.tenthPassingYear" name="tenthPassingYear" 
                   required min="1990" [max]="getCurrentYear()">
          </div>
          <div class="input-group">
            <label class="input-label">Percentage <span class="required">*</span></label>
            <input type="number" class="input-field" [(ngModel)]="educationLoanForm.tenthPercentage" name="tenthPercentage" 
                   required min="0" max="100" step="0.01">
          </div>
        </div>
      </div>

      <!-- Education Details - 12th -->
      <div class="form-section">
        <h4>üìö 12th Standard Details</h4>
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">School/College Name <span class="required">*</span></label>
            <input type="text" class="input-field" [(ngModel)]="educationLoanForm.twelfthSchoolName" name="twelfthSchoolName" required>
          </div>
          <div class="input-group">
            <label class="input-label">Board <span class="required">*</span></label>
            <select class="input-field" [(ngModel)]="educationLoanForm.twelfthBoard" name="twelfthBoard" required>
              <option value="">Select Board</option>
              <option value="CBSE">CBSE</option>
              <option value="ICSE">ICSE</option>
              <option value="State Board">State Board</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">Passing Year <span class="required">*</span></label>
            <input type="number" class="input-field" [(ngModel)]="educationLoanForm.twelfthPassingYear" name="twelfthPassingYear" 
                   required min="1990" [max]="getCurrentYear()">
          </div>
          <div class="input-group">
            <label class="input-label">Percentage <span class="required">*</span></label>
            <input type="number" class="input-field" [(ngModel)]="educationLoanForm.twelfthPercentage" name="twelfthPercentage" 
                   required min="0" max="100" step="0.01">
          </div>
        </div>
      </div>

      <!-- Education Details - UG -->
      <div class="form-section">
        <h4>üéì Undergraduate (UG) Details</h4>
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">College Name</label>
            <input type="text" class="input-field" [(ngModel)]="educationLoanForm.ugCollegeName" name="ugCollegeName">
          </div>
          <div class="input-group">
            <label class="input-label">University</label>
            <input type="text" class="input-field" [(ngModel)]="educationLoanForm.ugUniversity" name="ugUniversity">
          </div>
        </div>
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">Course</label>
            <input type="text" class="input-field" [(ngModel)]="educationLoanForm.ugCourse" name="ugCourse">
          </div>
          <div class="input-group">
            <label class="input-label">Admission Year</label>
            <input type="number" class="input-field" [(ngModel)]="educationLoanForm.ugAdmissionYear" name="ugAdmissionYear" 
                   min="1990" [max]="getCurrentYear()">
          </div>
        </div>
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">Expected Graduation Year</label>
            <input type="number" class="input-field" [(ngModel)]="educationLoanForm.ugExpectedGraduationYear" name="ugExpectedGraduationYear" 
                   min="1990" [max]="getMaxYear()">
          </div>
          <div class="input-group">
            <label class="input-label">Current CGPA</label>
            <input type="number" class="input-field" [(ngModel)]="educationLoanForm.ugCurrentCGPA" name="ugCurrentCGPA" 
                   min="0" max="10" step="0.01">
          </div>
        </div>
      </div>

      <!-- College/University Selection -->
      <div class="form-section">
        <h4>üè´ College/University for Loan</h4>
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">College Type <span class="required">*</span></label>
            <select class="input-field" [(ngModel)]="educationLoanForm.collegeType" name="collegeType" 
                    required (change)="onCollegeTypeChange()">
              <option value="">Select Type</option>
              <option value="IIT">IIT</option>
              <option value="IIM">IIM</option>
              <option value="University">University</option>
              <option value="College">College</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">State <span class="required">*</span></label>
            <select class="input-field" [(ngModel)]="selectedState" name="selectedState" 
                    required (change)="onStateChange()">
              <option value="">Select State</option>
              <option *ngFor="let state of getStates()" [value]="state">{{ state }}</option>
            </select>
          </div>
          <div class="input-group">
            <label class="input-label">City <span class="required">*</span></label>
            <select class="input-field" [(ngModel)]="selectedCity" name="selectedCity" 
                    required (change)="onCityChange()" [disabled]="!selectedState">
              <option value="">Select City</option>
              <option *ngFor="let city of getCitiesForState()" [value]="city">{{ city }}</option>
            </select>
          </div>
        </div>
        
        <!-- College Selection Dropdown -->
        <div class="input-group" *ngIf="filteredColleges.length > 0">
          <label class="input-label">Select College/University <span class="required">*</span></label>
          <select class="input-field" [(ngModel)]="educationLoanForm.collegeName" name="collegeName" 
                  required (change)="selectCollegeFromDropdown()">
            <option value="">Select from list</option>
            <option *ngFor="let college of filteredColleges" [value]="college.name">
              {{ college.name }} - {{ college.city }}, {{ college.state }}
            </option>
          </select>
        </div>
        
        <!-- Manual College Entry -->
        <div class="input-group">
          <label class="input-label">College/University Name <span class="required">*</span></label>
          <input type="text" class="input-field" [(ngModel)]="educationLoanForm.collegeName" name="collegeNameManual" 
                 required placeholder="Enter college name">
        </div>
        <div class="input-group">
          <label class="input-label">College Address</label>
          <textarea class="input-field" [(ngModel)]="educationLoanForm.collegeAddress" name="collegeAddress" 
                    rows="2" placeholder="Enter college address"></textarea>
        </div>
        
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">Course <span class="required">*</span></label>
            <input type="text" class="input-field" [(ngModel)]="educationLoanForm.collegeCourse" name="collegeCourse" required>
          </div>
          <div class="input-group">
            <label class="input-label">Degree Type <span class="required">*</span></label>
            <select class="input-field" [(ngModel)]="educationLoanForm.collegeDegree" name="collegeDegree" required>
              <option value="">Select Degree</option>
              <option value="UG">Undergraduate (UG)</option>
              <option value="PG">Postgraduate (PG)</option>
              <option value="PhD">PhD</option>
              <option value="Diploma">Diploma</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">Admission Year <span class="required">*</span></label>
            <input type="number" class="input-field" [(ngModel)]="educationLoanForm.collegeAdmissionYear" name="collegeAdmissionYear" 
                   required min="1990" [max]="getMaxGraduationYear()">
          </div>
          <div class="input-group">
            <label class="input-label">Course Duration (Years) <span class="required">*</span></label>
            <input type="number" class="input-field" [(ngModel)]="educationLoanForm.collegeCourseDuration" name="collegeCourseDuration" 
                   required min="1" max="10">
          </div>
        </div>
        
        <div class="input-group">
          <label class="input-label">Total Course Fee (‚Çπ) <span class="required">*</span></label>
          <input type="number" class="input-field" [(ngModel)]="educationLoanForm.collegeFeeAmount" name="collegeFeeAmount" 
                 required min="0" step="0.01">
        </div>
      </div>

      <!-- College Account Details -->
      <div class="form-section">
        <h4>üè¶ College Account Details</h4>
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">Account Number <span class="required">*</span></label>
            <input type="text" class="input-field" [(ngModel)]="educationLoanForm.collegeAccountNumber" name="collegeAccountNumber" required>
          </div>
          <div class="input-group">
            <label class="input-label">Account Holder Name <span class="required">*</span></label>
            <input type="text" class="input-field" [(ngModel)]="educationLoanForm.collegeAccountHolderName" name="collegeAccountHolderName" required>
          </div>
        </div>
        <div class="form-row">
          <div class="input-group">
            <label class="input-label">Bank Name <span class="required">*</span></label>
            <input type="text" class="input-field" [(ngModel)]="educationLoanForm.collegeBankName" name="collegeBankName" required>
          </div>
          <div class="input-group">
            <label class="input-label">Bank Branch</label>
            <input type="text" class="input-field" [(ngModel)]="educationLoanForm.collegeBankBranch" name="collegeBankBranch">
          </div>
        </div>
        <div class="input-group">
          <label class="input-label">IFSC Code <span class="required">*</span></label>
          <input type="text" class="input-field" [(ngModel)]="educationLoanForm.collegeIFSCCode" name="collegeIFSCCode" 
                 required pattern="[A-Z]{4}0[A-Z0-9]{6}" placeholder="ABCD0123456">
        </div>
      </div>

      <!-- Document Upload -->
      <div class="form-section">
        <h4>üìÑ Documents</h4>
        <div class="input-group">
          <label class="input-label">College Application/Admission Letter</label>
          <input type="file" class="input-field" (change)="onCollegeApplicationFileSelected($event)" 
                 accept=".pdf,.jpg,.jpeg,.png">
          <small class="input-hint">Upload college application or admission letter (PDF, JPG, PNG - Max 5MB)</small>
        </div>
      </div>
    </div>

    <div class="input-group">
      <label class="input-label">Loan Amount</label>
      <input
        type="number"
        class="input-field"
        placeholder="Enter loan amount"
        [(ngModel)]="loanForm.amount"
        name="amount"
        [max]="cibilInfo.creditLimit > 0 ? cibilInfo.creditLimit : null"
        required
      />
      <small class="input-hint" *ngIf="cibilInfo.creditLimit > 0">
        Maximum available credit limit: ‚Çπ{{ cibilInfo.creditLimit | number:'1.0-0' }}
      </small>
    </div>

    <div class="input-group">
      <label class="input-label">Tenure (Months)</label>
      <input
        type="number"
        class="input-field"
        placeholder="Loan tenure in months"
        [(ngModel)]="loanForm.tenure"
        name="tenure"
        required
      />
    </div>

    <div class="input-group">
      <label class="input-label">Interest Rate (%)</label>
      <input
        type="number"
        class="input-field"
        placeholder="Annual interest rate"
        [(ngModel)]="loanForm.interestRate"
        name="interestRate"
        [readonly]="cibilInfo.interestRate > 0"
        [class.readonly]="cibilInfo.interestRate > 0"
        required
        step="0.1"
      />
      <small class="input-hint" *ngIf="cibilInfo.interestRate > 0">
        Interest rate is auto-calculated based on your CIBIL score ({{ cibilInfo.interestRate }}% p.a.)
      </small>
    </div>

    <!-- Personal Loan Application Form Section -->
    <div *ngIf="loanForm.type === 'Personal Loan'" class="personal-loan-form-section">
      <h3 class="section-title">üìÑ Personal Loan Application Form</h3>
      
      <div class="form-section">
        <div class="input-group">
          <label class="input-label">Download Application Form</label>
          <button type="button" class="download-form-btn" (click)="downloadPersonalLoanForm()">
            üì• Download Application Form
          </button>
          <small class="input-hint">Download the Personal Loan application form, fill it, and upload it below.</small>
        </div>
        
        <div class="input-group">
          <label class="input-label">Upload Filled Application Form <span class="required">*</span></label>
          <input 
            type="file" 
            class="input-field" 
            (change)="onPersonalLoanFormSelected($event)" 
            accept=".pdf,.jpg,.jpeg,.png"
            [disabled]="personalLoanFormUploaded"
          />
          <small class="input-hint">Upload the filled Personal Loan application form (PDF, JPG, PNG - Max 5MB)</small>
          <div *ngIf="personalLoanFormFile" class="file-info">
            <span class="file-name">üìÑ {{ personalLoanFormFile.name }}</span>
            <button type="button" class="remove-file-btn" (click)="removePersonalLoanForm()" *ngIf="!personalLoanFormUploaded">‚úï</button>
          </div>
          <div *ngIf="personalLoanFormUploaded" class="success-message">
            ‚úì Form uploaded successfully
          </div>
        </div>
      </div>
    </div>

    <!-- Terms and Conditions -->
    <div class="form-group terms-section">
      <label class="terms-checkbox-label">
        <input 
          type="checkbox" 
          [(ngModel)]="termsAccepted" 
          name="termsAccepted"
          required
          class="terms-checkbox"
        />
        <span>I accept the <a href="#" (click)="showTermsModal = true; $event.preventDefault()" class="terms-link">Terms and Conditions</a> <span class="required">*</span></span>
      </label>
    </div>

    <div class="form-actions">
      <button class="submit-button" type="submit" [disabled]="loanForm.type === 'Personal Loan' && !personalLoanFormFile">Apply Loan</button>
      <button class="calculate-button" type="button" (click)="fillEMICalculator()">Calculate EMI</button>
    </div>
  </form>

  <!-- EMI Calculator Section -->
  <div class="emi-calculator">
    <h2>EMI Calculator</h2>
    <div class="calculator-container">
      <div class="calculator-inputs">
        <div class="input-group">
          <label class="input-label">Loan Amount (‚Çπ)</label>
          <input
            type="number"
            class="input-field"
            placeholder="Enter loan amount"
            [(ngModel)]="emiCalculator.principal"
            (input)="calculateEMI()"
            name="emiPrincipal"
          />
        </div>

        <div class="input-group">
          <label class="input-label">Interest Rate (% per annum)</label>
          <input
            type="number"
            class="input-field"
            placeholder="Enter interest rate"
            [(ngModel)]="emiCalculator.rate"
            (input)="calculateEMI()"
            name="emiRate"
            step="0.01"
          />
        </div>

        <div class="input-group">
          <label class="input-label">Loan Tenure (Months)</label>
          <input
            type="number"
            class="input-field"
            placeholder="Enter tenure in months"
            [(ngModel)]="emiCalculator.time"
            (input)="calculateEMI()"
            name="emiTime"
          />
        </div>
      </div>

      <div class="calculator-results" *ngIf="emiCalculator.emi > 0">
        <div class="result-card">
          <h3>EMI Calculation Results</h3>
          <div class="result-item">
            <span class="result-label">Monthly EMI:</span>
            <span class="result-value">‚Çπ{{ emiCalculator.emi | number:'1.2-2' }}</span>
          </div>
          <div class="result-item">
            <span class="result-label">Total Amount:</span>
            <span class="result-value">‚Çπ{{ emiCalculator.totalAmount | number:'1.2-2' }}</span>
          </div>
          <div class="result-item">
            <span class="result-label">Total Interest:</span>
            <span class="result-value">‚Çπ{{ emiCalculator.totalInterest | number:'1.2-2' }}</span>
          </div>
          <div class="result-item">
            <span class="result-label">Interest Percentage:</span>
            <span class="result-value">{{ emiCalculator.interestPercentage | number:'1.2-2' }}%</span>
          </div>
        </div>

        <div class="emi-breakdown" *ngIf="emiCalculator.emi > 0">
          <h4>EMI Breakdown</h4>
          <div class="breakdown-chart">
            <div class="breakdown-item">
              <div class="breakdown-bar principal" [style.width.%]="emiCalculator.principalPercentage"></div>
              <span class="breakdown-label">Principal ({{ emiCalculator.principalPercentage | number:'1.1-1' }}%)</span>
            </div>
            <div class="breakdown-item">
              <div class="breakdown-bar interest" [style.width.%]="emiCalculator.interestPercentage"></div>
              <span class="breakdown-label">Interest ({{ emiCalculator.interestPercentage | number:'1.1-1' }}%)</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Foreclosure Quick Access -->
  <div class="foreclosure-quick-access" *ngIf="hasApprovedLoans()">
    <div class="foreclosure-banner">
      <div class="foreclosure-banner-content">
        <h3>üè¶ Loan Foreclosure Available</h3>
        <p>You have approved loans that can be foreclosed. Contact admin or check below for foreclosure details.</p>
      </div>
    </div>
  </div>

  <div class="loan-list" *ngIf="loans.length > 0">
    <h2>My Loan Requests</h2>
    <div class="loan-table-container">
      <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Loan Account</th>
          <th>Type</th>
          <th>Amount</th>
          <th>Tenure</th>
          <th>Interest Rate</th>
          <th>CIBIL Score</th>
          <th>Status</th>
          <th>Applied Date</th>
          <th>Approved Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let loan of loans">
          <td>{{ loan.id }}</td>
          <td>{{ loan.loanAccountNumber }}</td>
          <td>{{ loan.type }}</td>
          <td>‚Çπ{{ loan.amount }}</td>
          <td>{{ loan.tenure }} months</td>
          <td>{{ loan.interestRate }}%</td>
          <td>
            <span *ngIf="loan.cibilScore" 
                  [ngClass]="{
                    'cibil-excellent': loan.cibilScore >= 750,
                    'cibil-good': loan.cibilScore >= 700 && loan.cibilScore < 750,
                    'cibil-fair': loan.cibilScore >= 650 && loan.cibilScore < 700,
                    'cibil-average': loan.cibilScore >= 600 && loan.cibilScore < 650,
                    'cibil-poor': loan.cibilScore < 600
                  }"
                  class="cibil-score-badge">
              {{ loan.cibilScore }}
            </span>
            <span *ngIf="!loan.cibilScore" class="cibil-na">N/A</span>
          </td>
          <td [class.pending]="loan.status === 'Pending'"
              [class.approved]="loan.status === 'Approved'"
              [class.rejected]="loan.status === 'Rejected'"
              [class.foreclosed]="loan.status === 'Foreclosed'">
            {{ loan.status }}
          </td>
          <td>{{ loan.applicationDate | date:'short' }}</td>
          <td>{{ loan.approvalDate ? (loan.approvalDate | date:'short') : '-' }}</td>
          <td>
            <button class="download-pdf-btn" (click)="downloadLoanPDF(loan)" title="Download Loan Details PDF">
               Download PDF
            </button>
            <button 
              *ngIf="loan.status === 'Foreclosed'" 
              class="download-foreclosure-btn" 
              (click)="downloadForeclosurePDF(loan)" 
              title="Download Foreclosure Statement PDF">
               üìÑ Foreclosure PDF
            </button>
            <button 
              *ngIf="loan.status === 'Approved' || loan.status === 'Paid'" 
              class="view-emi-btn" 
              (click)="showEmiDetails(loan)" 
              title="View EMI Details">
               üí≥ View EMIs
            </button>
          </td>
        </tr>
      </tbody>
      </table>
    </div>
    
    <!-- Foreclosure Information Section -->
    <div class="foreclosure-section" *ngIf="hasForeclosedLoans()">
      <h3>üè¶ Foreclosed Loans</h3>
      <div class="foreclosure-cards">
        <div class="foreclosure-card" *ngFor="let loan of loans" [hidden]="loan.status !== 'Foreclosed'">
          <div class="foreclosure-header">
            <h4>{{ loan.loanAccountNumber }}</h4>
            <span class="foreclosure-badge">Foreclosed</span>
          </div>
          <div class="foreclosure-details-grid">
            <div class="foreclosure-item">
              <span class="foreclosure-label">Foreclosure Date:</span>
              <span class="foreclosure-value">{{ loan.foreclosureDate | date:'short' }}</span>
            </div>
            <div class="foreclosure-item">
              <span class="foreclosure-label">Total Foreclosure Amount:</span>
              <span class="foreclosure-value highlight">‚Çπ{{ loan.foreclosureAmount | number:'1.2-2' }}</span>
            </div>
            <div class="foreclosure-item">
              <span class="foreclosure-label">Principal Paid:</span>
              <span class="foreclosure-value">‚Çπ{{ loan.principalPaid | number:'1.2-2' }}</span>
            </div>
            <div class="foreclosure-item">
              <span class="foreclosure-label">Interest Paid:</span>
              <span class="foreclosure-value">‚Çπ{{ loan.interestPaid | number:'1.2-2' }}</span>
            </div>
            <div class="foreclosure-item">
              <span class="foreclosure-label">Remaining Principal:</span>
              <span class="foreclosure-value">‚Çπ{{ loan.remainingPrincipal | number:'1.2-2' }}</span>
            </div>
            <div class="foreclosure-item">
              <span class="foreclosure-label">Remaining Interest:</span>
              <span class="foreclosure-value">‚Çπ{{ loan.remainingInterest | number:'1.2-2' }}</span>
            </div>
            <div class="foreclosure-item">
              <span class="foreclosure-label">Foreclosure Charges (4%):</span>
              <span class="foreclosure-value">‚Çπ{{ loan.foreclosureCharges | number:'1.2-2' }}</span>
            </div>
            <div class="foreclosure-item">
              <span class="foreclosure-label">GST (18% on Charges):</span>
              <span class="foreclosure-value">‚Çπ{{ loan.foreclosureGst | number:'1.2-2' }}</span>
            </div>
          </div>
          <div class="foreclosure-actions">
            <button class="download-foreclosure-pdf-btn" (click)="downloadForeclosurePDF(loan)">
              üìÑ Download Foreclosure Statement
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EMI Details Modal/Section -->
  <div class="emi-details-section" *ngIf="selectedLoanForEmi">
    <div class="emi-details-container">
      <div class="emi-header">
        <h2>EMI Payment Details - {{ selectedLoanForEmi.loanAccountNumber }}</h2>
        <button class="close-btn" (click)="closeEmiDetails()">‚úï</button>
      </div>
      
      <div class="loan-summary-card">
        <h3>Loan Summary</h3>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="summary-label">Loan Type:</span>
            <span class="summary-value">{{ selectedLoanForEmi.type }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Loan Amount:</span>
            <span class="summary-value">‚Çπ{{ selectedLoanForEmi.amount | number:'1.2-2' }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Tenure:</span>
            <span class="summary-value">{{ selectedLoanForEmi.tenure }} months</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Interest Rate:</span>
            <span class="summary-value">{{ selectedLoanForEmi.interestRate }}% p.a.</span>
          </div>
          <div class="summary-item" *ngIf="selectedLoanForEmi.emiStartDate">
            <span class="summary-label">EMI Start Date:</span>
            <span class="summary-value">{{ selectedLoanForEmi.emiStartDate | date:'dd-MM-yyyy' }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Current Balance:</span>
            <span class="summary-value">‚Çπ{{ currentBalance | number:'1.2-2' }}</span>
          </div>
        </div>
      </div>

      <!-- Next Due EMI Alert -->
      <div class="next-emi-alert" *ngIf="getNextDueEmi(selectedLoanForEmi.id)">
        <div class="alert-content">
          <h4>‚ö†Ô∏è Next EMI Due</h4>
          <p><strong>Due Date:</strong> {{ getNextDueEmi(selectedLoanForEmi.id)!.dueDate | date:'dd-MM-yyyy' }}</p>
          <p><strong>Amount:</strong> ‚Çπ{{ getNextDueEmi(selectedLoanForEmi.id)!.totalAmount | number:'1.2-2' }}</p>
          <button class="pay-now-btn" (click)="payEmi(getNextDueEmi(selectedLoanForEmi.id)!)" [disabled]="payingEmi">
            {{ payingEmi ? 'Processing...' : 'Pay Now' }}
          </button>
        </div>
      </div>

      <!-- EMI Schedule Table -->
      <div class="emi-schedule">
        <h3>EMI Schedule - Month by Month</h3>
        <div class="emi-summary-stats">
          <div class="stat-card">
            <span class="stat-label">Total EMIs</span>
            <span class="stat-value">{{ getTotalEmiCount(selectedLoanForEmi.id) }}</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Paid</span>
            <span class="stat-value paid-count">{{ getPaidEmiCount(selectedLoanForEmi.id) }}</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Pending</span>
            <span class="stat-value pending-count">{{ getPendingEmiCount(selectedLoanForEmi.id) }}</span>
          </div>
        </div>
        
        <!-- Bulk Payment Controls -->
        <div class="bulk-payment-controls" *ngIf="getPendingEmiCount(selectedLoanForEmi.id) > 0">
          <div class="bulk-controls-left">
            <label class="select-all-checkbox">
              <input type="checkbox" 
                     [checked]="selectedEmis.size > 0 && selectedEmis.size === getPendingEmiCount(selectedLoanForEmi.id)"
                     (change)="selectedEmis.size === getPendingEmiCount(selectedLoanForEmi.id) ? deselectAllEmis() : selectAllPendingEmis()">
              <span>Select All Pending ({{ getPendingEmiCount(selectedLoanForEmi.id) }})</span>
            </label>
            <span class="selected-count" *ngIf="selectedEmis.size > 0">
              {{ selectedEmis.size }} selected | Total: ‚Çπ{{ getSelectedEmisTotal() | number:'1.2-2' }}
            </span>
          </div>
          <div class="bulk-controls-right">
            <button class="pay-bulk-btn" 
                    (click)="payBulkEmis()" 
                    [disabled]="selectedEmis.size === 0 || payingBulkEmis || currentBalance < getSelectedEmisTotal()">
              <span class="btn-icon">üí≥</span>
              <span class="btn-text">Pay Selected ({{ selectedEmis.size }})</span>
            </button>
            <button class="clear-selection-btn" 
                    (click)="deselectAllEmis()" 
                    [disabled]="selectedEmis.size === 0">
              Clear Selection
            </button>
          </div>
        </div>
        
        <div class="emi-cards-container">
          <div *ngFor="let emi of getEmisForLoan(selectedLoanForEmi.id)" 
               class="emi-card"
               [class.emi-paid]="emi.status === 'Paid'"
               [class.emi-pending]="emi.status === 'Pending'"
               [class.emi-overdue]="emi.status === 'Overdue'"
               [class.emi-selected]="selectedEmis.has(emi.id)">
            
            <!-- Green Ticket for Paid EMIs -->
            <div class="paid-ticket" *ngIf="emi.status === 'Paid'">
              <div class="ticket-icon">‚úì</div>
              <div class="ticket-text">PAID</div>
            </div>
            
            <!-- Selection Checkbox -->
            <div class="emi-selection-checkbox" *ngIf="emi.status === 'Pending'">
              <input type="checkbox" 
                     [checked]="selectedEmis.has(emi.id)"
                     (change)="toggleEmiSelection(emi.id)">
            </div>
            
            <div class="emi-card-header">
              <div class="emi-number-badge">
                <span class="emi-number">EMI #{{ emi.emiNumber }}</span>
                <span class="emi-month">Month {{ emi.emiNumber }}</span>
              </div>
              <div class="emi-status-indicator" [class.status-paid]="emi.status === 'Paid'"
                   [class.status-pending]="emi.status === 'Pending'"
                   [class.status-overdue]="emi.status === 'Overdue'">
                <span class="status-dot"></span>
                <span class="status-text">{{ emi.status }}</span>
              </div>
            </div>
            
            <div class="emi-card-body">
              <div class="emi-due-date">
                <span class="date-label">Due Date:</span>
                <span class="date-value">{{ emi.dueDate | date:'dd MMM yyyy' }}</span>
              </div>
              
              <div class="emi-amount-breakdown">
                <div class="breakdown-row">
                  <span class="breakdown-label">Principal:</span>
                  <span class="breakdown-value">‚Çπ{{ emi.principalAmount | number:'1.2-2' }}</span>
                </div>
                <div class="breakdown-row">
                  <span class="breakdown-label">Interest:</span>
                  <span class="breakdown-value">‚Çπ{{ emi.interestAmount | number:'1.2-2' }}</span>
                </div>
                <div class="breakdown-row total-row">
                  <span class="breakdown-label">Total EMI:</span>
                  <span class="breakdown-value total-amount">‚Çπ{{ emi.totalAmount | number:'1.2-2' }}</span>
                </div>
              </div>
              
              <div class="emi-remaining">
                <span class="remaining-label">Remaining Principal:</span>
                <span class="remaining-value">‚Çπ{{ emi.remainingPrincipal | number:'1.2-2' }}</span>
              </div>
              
              <div class="emi-payment-info" *ngIf="emi.status === 'Paid' && emi.paymentDate">
                <div class="payment-date">
                  <span class="payment-label">Paid on:</span>
                  <span class="payment-value">{{ emi.paymentDate | date:'dd MMM yyyy' }}</span>
                </div>
              </div>
            </div>
            
            <div class="emi-card-actions">
              <button *ngIf="emi.status === 'Pending'" 
                      class="pay-emi-btn-card" 
                      (click)="payEmi(emi)" 
                      [disabled]="payingEmi">
                <span class="btn-icon">üí≥</span>
                <span class="btn-text">{{ payingEmi ? 'Processing...' : 'Pay Now' }}</span>
              </button>
              <button *ngIf="emi.status === 'Paid'" 
                      class="download-receipt-btn-card" 
                      (click)="downloadEmiReceipt(emi)">
                <span class="btn-icon">üìÑ</span>
                <span class="btn-text">Download Receipt</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EMI Payment Confirmation Modal -->
  <div class="emi-payment-modal-overlay" *ngIf="showEmiPaymentModal" (click)="closeEmiPaymentModal()">
    <div class="emi-payment-modal" (click)="$event.stopPropagation()" *ngIf="selectedEmiForPayment">
      <div class="modal-header">
        <h2>Confirm EMI Payment</h2>
        <button class="modal-close-btn" (click)="closeEmiPaymentModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <div class="payment-summary-card">
          <div class="summary-header">
            <div class="emi-number-large">EMI #{{ selectedEmiForPayment.emiNumber }}</div>
            <div class="loan-account-info">{{ selectedLoanForEmi?.loanAccountNumber }}</div>
          </div>
          
          <div class="payment-details-section">
            <h3>Payment Details</h3>
            <div class="detail-row">
              <span class="detail-label">Due Date:</span>
              <span class="detail-value">{{ selectedEmiForPayment.dueDate | date:'dd MMM yyyy' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Loan Type:</span>
              <span class="detail-value">{{ selectedLoanForEmi?.type }}</span>
            </div>
          </div>
          
          <div class="amount-breakdown-section">
            <h3>Amount Breakdown</h3>
            <div class="breakdown-item">
              <span class="breakdown-label">Principal Amount:</span>
              <span class="breakdown-amount">‚Çπ{{ selectedEmiForPayment.principalAmount | number:'1.2-2' }}</span>
            </div>
            <div class="breakdown-item">
              <span class="breakdown-label">Interest Amount:</span>
              <span class="breakdown-amount">‚Çπ{{ selectedEmiForPayment.interestAmount | number:'1.2-2' }}</span>
            </div>
            <div class="breakdown-item total-breakdown">
              <span class="breakdown-label">Total EMI Amount:</span>
              <span class="breakdown-amount total-emi-amount">‚Çπ{{ selectedEmiForPayment.totalAmount | number:'1.2-2' }}</span>
            </div>
          </div>
          
          <div class="account-info-section">
            <h3>Account Information</h3>
            <div class="detail-row">
              <span class="detail-label">Account Number:</span>
              <span class="detail-value">{{ userAccountNumber }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Current Balance:</span>
              <span class="detail-value">‚Çπ{{ currentBalance | number:'1.2-2' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Balance After Payment:</span>
              <span class="detail-value balance-after">‚Çπ{{ (currentBalance - selectedEmiForPayment.totalAmount) | number:'1.2-2' }}</span>
            </div>
          </div>
          
          <div class="remaining-info-section">
            <div class="remaining-item">
              <span class="remaining-label">Remaining Principal After Payment:</span>
              <span class="remaining-value">‚Çπ{{ selectedEmiForPayment.remainingPrincipal | number:'1.2-2' }}</span>
            </div>
          </div>
          
          <div class="payment-warning" *ngIf="currentBalance < selectedEmiForPayment.totalAmount">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <div class="warning-text">
              <strong>Insufficient Balance!</strong><br>
              Your current balance (‚Çπ{{ currentBalance | number:'1.2-2' }}) is less than the required amount (‚Çπ{{ selectedEmiForPayment.totalAmount | number:'1.2-2' }}).
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="cancel-btn" (click)="closeEmiPaymentModal()" [disabled]="payingEmi">
          Cancel
        </button>
        <button class="confirm-pay-btn" 
                (click)="confirmEmiPayment()" 
                [disabled]="payingEmi || currentBalance < selectedEmiForPayment.totalAmount">
          <span *ngIf="!payingEmi">üí≥ Confirm & Pay</span>
          <span *ngIf="payingEmi">‚è≥ Processing...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Bulk Payment Confirmation Modal -->
  <div class="emi-payment-modal-overlay" *ngIf="showBulkPaymentModal" (click)="closeBulkPaymentModal()">
    <div class="emi-payment-modal bulk-payment-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Confirm Bulk EMI Payment</h2>
        <button class="modal-close-btn" (click)="closeBulkPaymentModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <div class="payment-summary-card">
          <div class="summary-header">
            <div class="emi-number-large">Pay {{ getSelectedPendingEmis().length }} EMI(s)</div>
            <div class="loan-account-info">{{ selectedLoanForEmi?.loanAccountNumber }}</div>
          </div>
          
          <div class="bulk-payment-list">
            <h3>Selected EMIs:</h3>
            <div class="emi-list-item" *ngFor="let emi of getSelectedPendingEmis()">
              <div class="emi-item-info">
                <span class="emi-item-number">EMI #{{ emi.emiNumber }}</span>
                <span class="emi-item-date">Due: {{ emi.dueDate | date:'dd MMM yyyy' }}</span>
              </div>
              <span class="emi-item-amount">‚Çπ{{ emi.totalAmount | number:'1.2-2' }}</span>
            </div>
          </div>
          
          <div class="amount-breakdown-section">
            <h3>Payment Summary</h3>
            <div class="breakdown-row total-row">
              <span class="breakdown-label">Total Amount:</span>
              <span class="breakdown-value total-amount">‚Çπ{{ getSelectedEmisTotal() | number:'1.2-2' }}</span>
            </div>
            <div class="breakdown-row">
              <span class="breakdown-label">Current Balance:</span>
              <span class="breakdown-value">‚Çπ{{ currentBalance | number:'1.2-2' }}</span>
            </div>
            <div class="breakdown-row">
              <span class="breakdown-label">Balance After Payment:</span>
              <span class="breakdown-value">‚Çπ{{ (currentBalance - getSelectedEmisTotal()) | number:'1.2-2' }}</span>
            </div>
          </div>
          
          <div class="payment-warning" *ngIf="currentBalance < getSelectedEmisTotal()">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <div class="warning-text">
              <strong>Insufficient Balance!</strong><br>
              Your current balance (‚Çπ{{ currentBalance | number:'1.2-2' }}) is less than the required amount (‚Çπ{{ getSelectedEmisTotal() | number:'1.2-2' }}).
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="cancel-btn" (click)="closeBulkPaymentModal()" [disabled]="payingBulkEmis">
          Cancel
        </button>
        <button class="confirm-pay-btn" 
                (click)="confirmBulkPayment()" 
                [disabled]="payingBulkEmis || currentBalance < getSelectedEmisTotal()">
          <span *ngIf="!payingBulkEmis">üí≥ Confirm & Pay All</span>
          <span *ngIf="payingBulkEmis">‚è≥ Processing...</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Terms and Conditions Modal -->
<div *ngIf="showTermsModal" class="terms-modal-overlay" (click)="showTermsModal = false">
  <div class="terms-modal" (click)="$event.stopPropagation()">
    <div class="terms-modal-header">
      <h3>Terms and Conditions</h3>
      <button class="terms-modal-close" (click)="showTermsModal = false">√ó</button>
    </div>
    <div class="terms-modal-body">
      <h4>1. Loan Application Terms</h4>
      <ul>
        <li>By applying for a loan, you confirm that all information provided is accurate and complete.</li>
        <li>You authorize NeoBank to verify your credit history, employment, and financial information.</li>
        <li>False or misleading information may result in rejection of your application or legal action.</li>
      </ul>

      <h4>2. Loan Approval and Disbursement</h4>
      <ul>
        <li>Loan approval is subject to credit assessment and verification of documents.</li>
        <li>NeoBank reserves the right to approve or reject any loan application without assigning reasons.</li>
        <li>Approved loan amount will be credited to your account within 2-3 business days.</li>
      </ul>

      <h4>3. Interest Rates and Charges</h4>
      <ul>
        <li>Interest rates are determined based on your credit profile and may vary.</li>
        <li>Processing fees, prepayment charges, and other applicable charges will be communicated separately.</li>
        <li>Interest rates are subject to change as per market conditions and RBI guidelines.</li>
      </ul>

      <h4>4. Repayment Obligations</h4>
      <ul>
        <li>You are responsible for timely payment of all EMIs as per the schedule.</li>
        <li>Late payment charges and penalties will apply for overdue amounts.</li>
        <li>Default in repayment may affect your credit score and may lead to legal action.</li>
      </ul>

      <h4>5. Personal Information</h4>
      <ul>
        <li>Your personal and financial information will be kept confidential as per banking regulations.</li>
        <li>NeoBank may share information with credit bureaus and regulatory authorities as required.</li>
        <li>You consent to receive communications via email, SMS, and phone regarding your loan.</li>
      </ul>

      <h4>6. General Terms</h4>
      <ul>
        <li>These terms are subject to change, and you will be notified of any material changes.</li>
        <li>NeoBank reserves the right to modify loan terms, interest rates, and charges.</li>
        <li>Disputes, if any, will be subject to the jurisdiction of courts in Mumbai, India.</li>
      </ul>

      <p style="margin-top: 20px; font-weight: 600; color: #0077cc;">
        By accepting these terms, you acknowledge that you have read, understood, and agree to be bound by all the terms and conditions mentioned above.
      </p>
    </div>
  </div>
</div>
