<div class="create-account-container">
  <div class="header-section">
    <div class="brand-container">
      <img src="/favicon.ico" alt="NeoBank Logo" class="logo">
      <span class="brand-name">NeoBank</span>
    </div>
    <h2>Create New Account</h2>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>Creating your account...</p>
  </div>

  <!--  Success & Error messages -->
  <div *ngIf="submitError" class="error-msg">
    {{ submitError }}
  </div>
  <div *ngIf="successMessage" class="success-msg">
    {{ successMessage }}
  </div>

  <!-- Approval Tracking Section -->
  <div class="tracking-section">
    <button type="button" (click)="toggleTracking()" class="tracking-toggle-btn">
      <i class="fa" [ngClass]="showTracking ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
      {{ showTracking ? 'Hide' : 'Track' }} Approval Status
    </button>
    
    <div *ngIf="showTracking" class="tracking-form">
      <h3><i class="fa fa-search-location"></i> Track Your Account Approval</h3>
      <p>Enter your Aadhar number and mobile number to check your account creation status.</p>
      
      <div class="form-group">
        <label><i class="fa fa-id-card"></i> Aadhar Number</label>
        <input 
          type="text" 
          [(ngModel)]="trackingAadhar" 
          placeholder="Enter your 12-digit Aadhar number" 
          maxlength="12"
          (input)="filterDigits('aadhar', $event)"
        />
      </div>
      
      <div class="form-group">
        <label><i class="fa fa-phone"></i> Mobile Number</label>
        <input 
          type="text" 
          [(ngModel)]="trackingMobile" 
          placeholder="Enter your 10-digit mobile number" 
          maxlength="10"
          (input)="filterDigits('mobile', $event)"
        />
      </div>
      
      <button type="button" (click)="trackApproval()" class="track-btn" [disabled]="trackingLoading">
        <i class="fa" [ngClass]="trackingLoading ? 'fa-spinner fa-spin' : 'fa-search'"></i>
        {{ trackingLoading ? 'Checking...' : 'Check Status' }}
      </button>
      
      <!-- Tracking Results -->
      <div *ngIf="trackingError" class="error-msg">
        <i class="fa fa-exclamation-circle"></i> {{ trackingError }}
      </div>
      
      <div *ngIf="trackingResult" class="tracking-result">
        <h4><i class="fa fa-info-circle"></i> Account Tracking Status</h4>
        <div class="status-info">
          <div class="tracking-detail-item">
            <label><i class="fa fa-barcode"></i> Tracking ID:</label>
            <span class="tracking-id">{{ trackingResult.trackingId }}</span>
          </div>
          <div class="tracking-detail-item">
            <label><i class="fa fa-id-card"></i> Aadhar Number:</label>
            <span>{{ trackingResult.aadharNumber }}</span>
          </div>
          <div class="tracking-detail-item">
            <label><i class="fa fa-phone"></i> Mobile Number:</label>
            <span>{{ trackingResult.mobileNumber }}</span>
          </div>
          <div class="tracking-detail-item">
            <label><i class="fa fa-envelope"></i> Email:</label>
            <span>{{ trackingResult.user?.email || 'N/A' }}</span>
          </div>
          <div class="tracking-detail-item">
            <label><i class="fa fa-info-circle"></i> Status:</label>
            <span [ngClass]="getTrackingStatusClass(trackingResult.status)" class="status-badge">
              {{ getTrackingStatusLabel(trackingResult.status) }}
            </span>
          </div>
          <div class="tracking-detail-item">
            <label><i class="fa fa-calendar"></i> Created At:</label>
            <span>{{ trackingResult.createdAt | date:'medium' }}</span>
          </div>
          <div class="tracking-detail-item" *ngIf="trackingResult.updatedAt">
            <label><i class="fa fa-clock"></i> Last Updated:</label>
            <span>{{ trackingResult.updatedAt | date:'medium' }}</span>
          </div>
          <div class="tracking-detail-item" *ngIf="trackingResult.updatedBy">
            <label><i class="fa fa-user-shield"></i> Updated By:</label>
            <span>{{ trackingResult.updatedBy }}</span>
          </div>
        </div>
        
        <div class="status-message" [ngClass]="getTrackingStatusClass(trackingResult.status)">
          <i class="fa" [ngClass]="getTrackingStatusIcon(trackingResult.status)"></i>
          <p>{{ getTrackingStatusMessage(trackingResult.status) }}</p>
        </div>
      </div>
    </div>
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()">

    <!-- Name -->
    <div class="form-group">
      <label>Full Name</label>
      <input type="text" formControlName="name" placeholder="Enter your name" />
      <div *ngIf="submitted && f['name'].errors" class="error">
        <small *ngIf="f['name'].errors['required']">Name is required.</small>
        <small *ngIf="f['name'].errors['minlength']">Name must be at least 2 characters.</small>
      </div>
    </div>

    <!-- Email -->
    <div class="form-group">
      <label>Email (Gmail only)</label>
      <input type="email" formControlName="email" placeholder="Enter your Gmail" />
      <div *ngIf="submitted && f['email'].errors" class="error">
        <small *ngIf="f['email'].errors['required']">Email is required.</small>
        <small *ngIf="f['email'].errors['email']">Invalid email format.</small>
        <small *ngIf="f['email'].errors['gmailOnly']">Only Gmail addresses allowed.</small>
      </div>
    </div>

    <!-- DOB -->
    <div class="form-group">
      <label>Date of Birth</label>
      <input type="date" formControlName="dob" />
      <div *ngIf="submitted && f['dob'].errors" class="error">
        <small>Date of birth is required.</small>
      </div>
    </div>

    <!-- Income -->
    <div class="form-group">
      <label>Income</label>
      <input type="number" formControlName="income" placeholder="Enter income" />
      <div *ngIf="submitted && f['income'].errors" class="error">
        <small *ngIf="f['income'].errors?.['required']">Income is required.</small>
        <small *ngIf="f['income'].errors?.['min']">Income cannot be negative.</small>
      </div>
    </div>

    <!-- Occupation -->
    <div class="form-group">
      <label>Occupation</label>
      <input type="text" formControlName="occupation" placeholder="Enter occupation" />
      <div *ngIf="submitted && f['occupation'].errors" class="error">
        <small>Occupation is required.</small>
      </div>
    </div>

    <!-- PAN -->
    <div class="form-group">
      <label>PAN</label>
      <input type="text" formControlName="pan" placeholder="ABCDE1234F" />
      <div *ngIf="panChecking" class="info">
        <small>Checking PAN availability...</small>
      </div>
      <div *ngIf="submitted && f['pan'].errors" class="error">
        <small *ngIf="f['pan'].errors['required']">PAN is required.</small>
        <small *ngIf="f['pan'].errors['invalidPan']">Invalid PAN format.</small>
      </div>
      <div *ngIf="panExists && f['pan'].valid && f['pan'].touched" class="error">
        <small>⚠️ PAN number is already registered. Another account exists with this PAN number.</small>
      </div>
      <div *ngIf="!panExists && !panChecking && f['pan'].valid && f['pan'].touched" class="success">
        <small>✓ PAN number is available</small>
      </div>
    </div>

    <!-- Aadhar -->
    <div class="form-group">
      <label>Aadhar</label>
      <div class="aadhar-input-container">
        <input 
          type="text" 
          formControlName="aadhar" 
          placeholder="12-digit Aadhar" 
          maxlength="12"
          class="aadhar-input"
          [class.valid]="f['aadhar'].valid && f['aadhar'].touched && !aadharExists"
          [class.invalid]="f['aadhar'].invalid && f['aadhar'].touched || aadharExists"
        />
        <div class="validation-indicator">
          <span *ngIf="f['aadhar'].valid && f['aadhar'].touched && !aadharExists && !aadharChecking" class="valid-icon"></span>
          <span *ngIf="(f['aadhar'].invalid && f['aadhar'].touched) || aadharExists" class="invalid-icon"></span>
        </div>
      </div>
      <div *ngIf="aadharChecking" class="info">
        <small>Checking Aadhar availability...</small>
      </div>
      <div *ngIf="submitted && f['aadhar'].errors" class="error">
        <small *ngIf="f['aadhar'].errors['required']">Aadhar is required.</small>
        <small *ngIf="f['aadhar'].errors['invalidAadhar']">Invalid Aadhar format. Must be 12 digits starting with 2-9.</small>
        <small *ngIf="f['aadhar'].errors['invalidAadharChecksum']">Invalid Aadhar number. Please check the digits.</small>
      </div>
      <div *ngIf="aadharExists && f['aadhar'].valid && f['aadhar'].touched" class="error">
        <small>⚠️ Aadhar number is already registered. Another account exists with this Aadhar number.</small>
      </div>
      <div *ngIf="!aadharExists && !aadharChecking && f['aadhar'].valid && f['aadhar'].touched" class="success">
        <small>✓ Valid Aadhaar number and available</small>
      </div>
    </div>

    <!-- Mobile -->
    <div class="form-group">
      <label>Mobile</label>
      <input type="text" formControlName="mobile" placeholder="10-digit Mobile" /> 
      <div *ngIf="mobileChecking" class="info">
        <small>Checking mobile number availability...</small>
      </div>
      <div *ngIf="submitted && f['mobile'].errors" class="error">
        <small *ngIf="f['mobile'].errors?.['required']">Mobile is required.</small>
        <small *ngIf="f['mobile'].errors?.['invalidMobile']">Invalid mobile number.</small>
      </div>
      <div *ngIf="mobileExists && f['mobile'].valid && f['mobile'].touched" class="error">
        <small>⚠️ Mobile number is already registered. Another account exists with this mobile number.</small>
      </div>
      <div *ngIf="!mobileExists && !mobileChecking && f['mobile'].valid && f['mobile'].touched" class="success">
        <small>✓ Mobile number is available</small>
      </div>
    </div>

    <!-- State -->
    <div class="form-group">
      <label>State</label>
      <select formControlName="state" class="state-dropdown">
        <option value="">Select your state</option>
        <option *ngFor="let state of indianStates" [value]="state">{{ state }}</option>
      </select>
      <div *ngIf="submitted && f['state'].errors" class="error">
        <small>State is required.</small>
      </div>
    </div>

    <!-- City -->
    <div class="form-group">
      <label>City</label>
      <select formControlName="city" class="city-dropdown">
        <option value="">Select your city</option>
        <option *ngFor="let city of availableCities" [value]="city">{{ city }}</option>
      </select>
      <div *ngIf="submitted && f['city'].errors" class="error">
        <small>City is required.</small>
      </div>
      <div *ngIf="!availableCities.length && f['state'].value" class="info">
        <small>Please select a state first to see available cities.</small>
      </div>
    </div>

    <!-- Password -->
    <div class="form-group">
      <label>Password</label>
      <input type="password" formControlName="password" placeholder="Enter password" /> 
      <div *ngIf="submitted && f['password'].errors" class="error">
        <small *ngIf="f['password'].errors?.['required']">Password is required.</small>
        <small *ngIf="f['password'].errors?.['minlength']">Password must be at least 6 characters.</small>
      </div>
    </div>

    <!-- Confirm Password -->
    <div class="form-group">
      <label>Confirm Password</label>
      <input type="password" formControlName="confirmPassword" placeholder="Re-enter password" />
      <div *ngIf="submitted && (f['confirmPassword'].errors || form.errors?.['passwordsMismatch'])" class="error">
        <small *ngIf="f['confirmPassword'].errors?.['required']">Confirm Password is required.</small>
        <small *ngIf="form.errors?.['passwordsMismatch']">Passwords do not match.</small>
      </div>
    </div>

    <!-- Terms and Conditions -->
    <div class="form-group terms-group">
      <label class="terms-label">
        <input 
          type="checkbox" 
          formControlName="termsAccepted" 
          class="terms-checkbox"
        />
        <span>I accept the <a href="#" (click)="showTerms($event)" class="terms-link">Terms and Conditions</a> and <a href="#" (click)="showPrivacy($event)" class="terms-link">Privacy Policy</a></span>
      </label>
      <div *ngIf="submitted && f['termsAccepted'].errors" class="error">
        <small>You must accept the Terms and Conditions to create an account.</small>
      </div>
    </div>

    <!-- Submit -->
    <button type="submit" [disabled]="!form.get('termsAccepted')?.value">Submit Account Request</button>
  </form>

  <!-- Back Button -->
  <div class="back-button-section">
    <button class="back-button" (click)="goBack()">
      ← Back to Landing Page
    </button>
  </div>
</div>
