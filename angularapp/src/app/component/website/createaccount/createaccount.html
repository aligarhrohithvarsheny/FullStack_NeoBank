<div class="create-account-container">
  <h2>Create New Account</h2>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>Creating your account...</p>
  </div>

  <!--  Success & Error messages -->
  <div *ngIf="submitError" class="error-msg">
    {{ submitError }}
  </div>
  <div *ngIf="successMessage" class="success-msg">
    {{ successMessage }}
  </div>

  <!-- Approval Tracking Section -->
  <div class="tracking-section">
    <button type="button" (click)="toggleTracking()" class="tracking-toggle-btn">
      {{ showTracking ? 'Hide' : 'Track' }} Approval Status
    </button>
    
    <div *ngIf="showTracking" class="tracking-form">
      <h3>Track Your Account Approval</h3>
      <p>Enter your email and mobile number to check your account status.</p>
      
      <div class="form-group">
        <label>Email</label>
        <input type="email" [(ngModel)]="trackingEmail" placeholder="Enter your email" />
      </div>
      
      <div class="form-group">
        <label>Mobile Number</label>
        <input type="text" [(ngModel)]="trackingMobile" placeholder="Enter your mobile number" />
      </div>
      
      <button type="button" (click)="trackApproval()">Check Status</button>
      
      <!-- Tracking Results -->
      <div *ngIf="trackingError" class="error-msg">
        {{ trackingError }}
      </div>
      
      <div *ngIf="trackingResult" class="tracking-result">
        <h4>Account Status</h4>
        <div class="status-info">
          <p><strong>Name:</strong> {{ trackingResult.name }}</p>
          <p><strong>Email:</strong> {{ trackingResult.email }}</p>
          <p><strong>Mobile:</strong> {{ trackingResult.mobile }}</p>
          <p><strong>Status:</strong> 
            <span [ngClass]="{'pending': trackingResult.status==='PENDING', 'approved': trackingResult.status==='APPROVED', 'closed': trackingResult.status==='CLOSED'}">
              {{ trackingResult.status }}
            </span>
          </p>
          <p *ngIf="trackingResult.assignedAccountNumber"><strong>Account Number:</strong> {{ trackingResult.assignedAccountNumber }}</p>
          <p><strong>Request ID:</strong> {{ trackingResult.id }}</p>
          <p><strong>Submitted:</strong> {{ trackingResult.createdAt | date:'medium' }}</p>
        </div>
      </div>
    </div>
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()">

    <!-- Name -->
    <div class="form-group">
      <label>Full Name</label>
      <input type="text" formControlName="name" placeholder="Enter your name" />
      <div *ngIf="submitted && f['name'].errors" class="error">
        <small *ngIf="f['name'].errors['required']">Name is required.</small>
        <small *ngIf="f['name'].errors['minlength']">Name must be at least 2 characters.</small>
      </div>
    </div>

    <!-- Email -->
    <div class="form-group">
      <label>Email (Gmail only)</label>
      <input type="email" formControlName="email" placeholder="Enter your Gmail" />
      <div *ngIf="submitted && f['email'].errors" class="error">
        <small *ngIf="f['email'].errors['required']">Email is required.</small>
        <small *ngIf="f['email'].errors['email']">Invalid email format.</small>
        <small *ngIf="f['email'].errors['gmailOnly']">Only Gmail addresses allowed.</small>
      </div>
    </div>

    <!-- DOB -->
    <div class="form-group">
      <label>Date of Birth</label>
      <input type="date" formControlName="dob" />
      <div *ngIf="submitted && f['dob'].errors" class="error">
        <small>Date of birth is required.</small>
      </div>
    </div>

    <!-- Income -->
    <div class="form-group">
      <label>Income</label>
      <input type="number" formControlName="income" placeholder="Enter income" />
      <div *ngIf="submitted && f['income'].errors" class="error">
        <small *ngIf="f['income'].errors?.['required']">Income is required.</small>
        <small *ngIf="f['income'].errors?.['min']">Income cannot be negative.</small>
      </div>
    </div>

    <!-- Occupation -->
    <div class="form-group">
      <label>Occupation</label>
      <input type="text" formControlName="occupation" placeholder="Enter occupation" />
      <div *ngIf="submitted && f['occupation'].errors" class="error">
        <small>Occupation is required.</small>
      </div>
    </div>

    <!-- PAN -->
    <div class="form-group">
      <label>PAN</label>
      <input type="text" formControlName="pan" placeholder="ABCDE1234F" />
      <div *ngIf="submitted && f['pan'].errors" class="error">
        <small *ngIf="f['pan'].errors['required']">PAN is required.</small>
        <small *ngIf="f['pan'].errors['invalidPan']">Invalid PAN format.</small>
      </div>
    </div>

    <!-- Aadhar -->
    <div class="form-group">
      <label>Aadhar</label>
      <div class="aadhar-input-container">
        <input 
          type="text" 
          formControlName="aadhar" 
          placeholder="12-digit Aadhar" 
          maxlength="12"
          class="aadhar-input"
          [class.valid]="f['aadhar'].valid && f['aadhar'].touched"
          [class.invalid]="f['aadhar'].invalid && f['aadhar'].touched"
        />
        <div class="validation-indicator">
          <span *ngIf="f['aadhar'].valid && f['aadhar'].touched" class="valid-icon"></span>
          <span *ngIf="f['aadhar'].invalid && f['aadhar'].touched" class="invalid-icon"></span>
        </div>
      </div>
      <div *ngIf="submitted && f['aadhar'].errors" class="error">
        <small *ngIf="f['aadhar'].errors['required']">Aadhar is required.</small>
        <small *ngIf="f['aadhar'].errors['invalidAadhar']">Invalid Aadhar format. Must be 12 digits starting with 2-9.</small>
        <small *ngIf="f['aadhar'].errors['invalidAadharChecksum']">Invalid Aadhar number. Please check the digits.</small>
      </div>
      <div *ngIf="f['aadhar'].valid && f['aadhar'].touched" class="success">
        <small> Valid Aadhaar number</small>
      </div>
    </div>

    <!-- Mobile -->
    <div class="form-group">
      <label>Mobile</label>
      <input type="text" formControlName="mobile" placeholder="10-digit Mobile" /> 
      <div *ngIf="submitted && f['mobile'].errors" class="error">
        <small *ngIf="f['mobile'].errors?.['required']">Mobile is required.</small>
        <small *ngIf="f['mobile'].errors?.['invalidMobile']">Invalid mobile number.</small>
      </div>
    </div>

    <!-- State -->
    <div class="form-group">
      <label>State</label>
      <select formControlName="state" class="state-dropdown">
        <option value="">Select your state</option>
        <option *ngFor="let state of indianStates" [value]="state">{{ state }}</option>
      </select>
      <div *ngIf="submitted && f['state'].errors" class="error">
        <small>State is required.</small>
      </div>
    </div>

    <!-- City -->
    <div class="form-group">
      <label>City</label>
      <select formControlName="city" class="city-dropdown" [disabled]="!availableCities.length">
        <option value="">Select your city</option>
        <option *ngFor="let city of availableCities" [value]="city">{{ city }}</option>
      </select>
      <div *ngIf="submitted && f['city'].errors" class="error">
        <small>City is required.</small>
      </div>
      <div *ngIf="!availableCities.length && f['state'].value" class="info">
        <small>Please select a state first to see available cities.</small>
      </div>
    </div>

    <!-- Password -->
    <div class="form-group">
      <label>Password</label>
      <input type="password" formControlName="password" placeholder="Enter password" /> 
      <div *ngIf="submitted && f['password'].errors" class="error">
        <small *ngIf="f['password'].errors?.['required']">Password is required.</small>
        <small *ngIf="f['password'].errors?.['minlength']">Password must be at least 6 characters.</small>
      </div>
    </div>

    <!-- Confirm Password -->
    <div class="form-group">
      <label>Confirm Password</label>
      <input type="password" formControlName="confirmPassword" placeholder="Re-enter password" />
      <div *ngIf="submitted && (f['confirmPassword'].errors || form.errors?.['passwordsMismatch'])" class="error">
        <small *ngIf="f['confirmPassword'].errors?.['required']">Confirm Password is required.</small>
        <small *ngIf="form.errors?.['passwordsMismatch']">Passwords do not match.</small>
      </div>
    </div>

    <!-- Submit -->
    <button type="submit">Submit Account Request</button>
  </form>
</div>
