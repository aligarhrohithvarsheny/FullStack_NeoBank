<!-- Include Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="dashboard-container">
  <header>
    <h2>Admin Dashboard</h2>
    <button class="logout-btn" (click)="logout()">Logout</button>
  </header>


  <!-- User Search Section -->
  <div class="search-section">
    <div class="search-header">
      <h3>Search Users</h3>
      <button class="refresh-btn" (click)="refreshUsersData()" title="Refresh data from database">
        Refresh Data
      </button>
    </div>
    <div class="search-form">
      <div class="search-input-group">
        <input 
          type="text" 
          [(ngModel)]="searchQuery" 
          placeholder="Search by name, mobile number, or last 4 digits of card..."
          class="search-input"
          (keyup.enter)="searchUsers()"
        >
        <button class="search-btn" (click)="searchUsers()">
          Search
        </button>
        <button class="pdf-download-btn" (click)="downloadAllUsersPDF()" [disabled]="users.length === 0" title="Download all users details as PDF">
          <i class="fa fa-file-pdf"></i> Download PDF
        </button>
      </div>
      <div class="search-results" *ngIf="searchResults.length > 0">
        <h4><i class="fa fa-users"></i> Search Results ({{ searchResults.length }} found)</h4>
        <div class="results-list">
          <div 
            *ngFor="let user of searchResults" 
            class="result-item"
            (click)="selectSearchedUser(user)"
            [class.selected]="selectedSearchedUser?.id === user.id"
          >
            <div class="user-basic-info">
              <h5>{{ user.name }}</h5>
              <p>{{ user.email }}</p>
              <p>Account: {{ user.accountNumber }}</p>
            </div>
            <div class="user-balance">
              <span class="balance">‚Çπ{{ user.balance | number:'1.2-2' }}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="no-results" *ngIf="searchQuery && searchResults.length === 0 && !isSearching">
        <i class="fa fa-exclamation-circle"></i>
        <p>No users found matching your search criteria.</p>
      </div>
      <div class="search-info" *ngIf="!searchQuery">
        <i class="fa fa-info-circle"></i>
        <p>Total users in database: {{ users.length }}</p>
      </div>
    </div>
  </div>

  <!-- User Details Modal -->
  <div class="user-details-modal" *ngIf="selectedSearchedUser">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fa fa-user"></i> Complete User Details</h3>
        <div class="header-actions">
          <button class="pdf-download-btn" (click)="downloadUserDetailsPDF(selectedSearchedUser)" title="Download user details as PDF">
            <i class="fa fa-file-pdf"></i> Download PDF
          </button>
          <button class="close-btn" (click)="closeUserDetails()">
            <i class="fa fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="modal-body">
        <!-- Personal Information -->
        <div class="details-section">
          <h4><i class="fa fa-id-card"></i> Personal Information</h4>
          <div class="details-grid">
            <div class="detail-item">
              <label>Full Name</label>
              <span>{{ selectedSearchedUser.name }}</span>
            </div>
            <div class="detail-item">
              <label>Email</label>
              <span>{{ selectedSearchedUser.email }}</span>
            </div>
            <div class="detail-item">
              <label>Account Number</label>
              <span>{{ selectedSearchedUser.accountNumber }}</span>
            </div>
            <div class="detail-item">
              <label>Phone Number</label>
              <span>{{ selectedSearchedUser.phoneNumber || 'Not provided' }}</span>
            </div>
            <div class="detail-item">
              <label>Date of Birth</label>
              <span>{{ selectedSearchedUser.dateOfBirth || 'Not provided' }}</span>
            </div>
            <div class="detail-item">
              <label>Address</label>
              <span>{{ selectedSearchedUser.address || 'Not provided' }}</span>
            </div>
            <div class="detail-item">
              <label>PAN Number</label>
              <span>{{ selectedSearchedUser.pan || 'Not provided' }}</span>
            </div>
            <div class="detail-item">
              <label>Aadhar Number</label>
              <span>{{ selectedSearchedUser.aadhar || 'Not provided' }}</span>
            </div>
            <div class="detail-item">
              <label>Occupation</label>
              <span>{{ selectedSearchedUser.occupation || 'Not provided' }}</span>
            </div>
            <div class="detail-item">
              <label>Annual Income</label>
              <span>‚Çπ{{ selectedSearchedUser.income | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item">
              <label>Account Type</label>
              <span>{{ selectedSearchedUser.accountType }}</span>
            </div>
            <div class="detail-item">
              <label>Account Opened</label>
              <span>{{ selectedSearchedUser.joinDate }}</span>
            </div>
            <div class="detail-item">
              <label>Current Balance</label>
              <span class="balance-amount">‚Çπ{{ selectedSearchedUser.balance | number:'1.2-2' }}</span>
            </div>
          </div>
        </div>

        <!-- Cards Information -->
        <div class="details-section" *ngIf="userCards.length > 0">
          <h4><i class="fa fa-credit-card"></i> Cards Information</h4>
          <div class="cards-grid">
            <div *ngFor="let card of userCards" class="card-item">
              <div class="card-header">
                <h5>{{ card.cardType || 'Debit Card' }}</h5>
                <span class="card-status" [ngClass]="card.status.toLowerCase()">{{ card.status }}</span>
              </div>
              <div class="card-details">
                <p><strong>Card Number:</strong> **** **** **** {{ card.cardNumber.slice(-4) }}</p>
                <p><strong>Expiry:</strong> {{ card.expiry }}</p>
                <p><strong>CVV:</strong> {{ card.cvv }}</p>
                <p><strong>PIN Set:</strong> {{ card.pinSet ? 'Yes' : 'No' }}</p>
                <p><strong>Blocked:</strong> {{ card.blocked ? 'Yes' : 'No' }}</p>
                <p><strong>Deactivated:</strong> {{ card.deactivated ? 'Yes' : 'No' }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Loans Information -->
        <div class="details-section" *ngIf="userLoans.length > 0">
          <h4><i class="fa fa-coins"></i> Loans Information</h4>
          <div class="loans-grid">
            <div *ngFor="let loan of userLoans" class="loan-item">
              <div class="loan-header">
                <h5>{{ loan.loanType || 'Personal Loan' }}</h5>
                <span class="loan-status" [ngClass]="loan.status.toLowerCase()">{{ loan.status }}</span>
              </div>
              <div class="loan-details">
                <p><strong>Amount:</strong> ‚Çπ{{ loan.amount | number:'1.2-2' }}</p>
                <p><strong>Interest Rate:</strong> {{ loan.interestRate }}%</p>
                <p><strong>Tenure:</strong> {{ loan.tenure }} months</p>
                <p><strong>EMI:</strong> ‚Çπ{{ loan.emi | number:'1.2-2' }}</p>
                <p><strong>Applied Date:</strong> {{ loan.appliedDate }}</p>
                <p><strong>Approved Date:</strong> {{ loan.approvedDate || 'Pending' }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Transactions -->
        <div class="details-section" *ngIf="userTransactions.length > 0">
          <h4><i class="fa fa-chart-line"></i> Recent Transactions</h4>
          <div class="transactions-table">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Description</th>
                  <th>Balance</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let transaction of userTransactions.slice(0, 10)">
                  <td>{{ transaction.date }}</td>
                  <td>
                    <span class="transaction-type" [ngClass]="transaction.type.toLowerCase()">
                      {{ transaction.type }}
                    </span>
                  </td>
                  <td class="amount" [ngClass]="transaction.type === 'Credit' ? 'positive' : 'negative'">
                    {{ transaction.type === 'Credit' ? '+' : '-' }}‚Çπ{{ transaction.amount | number:'1.2-2' }}
                  </td>
                  <td>{{ transaction.description }}</td>
                  <td>‚Çπ{{ transaction.balance | number:'1.2-2' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions Section -->
  <div class="quick-actions">
    <h3>Quick Actions</h3>
    
    <!-- Direct Deposit/Withdrawal Form -->
    <div class="transaction-form-section">
      <div class="form-row">
        <div class="form-group">
          <label for="userSelect">Select User</label>
          <select id="userSelect" [(ngModel)]="selectedUserId" class="form-select" (change)="onUserSelect()">
            <option value="">-- Select User --</option>
            <option *ngFor="let user of filteredUsers" [value]="user.id">
              {{ user.name }} ({{ user.accountNumber }}) - ‚Çπ{{ user.balance | number:'1.2-2' }}
            </option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="operationType">Operation</label>
          <select id="operationType" [(ngModel)]="operationType" class="form-select">
            <option value="deposit">Deposit Money</option>
            <option value="withdrawal">Withdraw Money</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="amount">Amount (‚Çπ)</label>
          <input 
            type="number" 
            id="amount" 
            [(ngModel)]="amount" 
            placeholder="Enter amount"
            min="1"
            max="1000000"
            class="form-input"
          >
        </div>
        
        <div class="form-group">
          <label for="description">Description</label>
          <input 
            type="text" 
            id="description" 
            [(ngModel)]="description" 
            placeholder="Enter transaction description"
            class="form-input"
          >
        </div>
      </div>
      
      <!-- Selected User Info -->
      <div class="selected-user-display" *ngIf="selectedUser">
        <h4><i class="fa fa-user"></i> Selected User Details</h4>
        <div class="user-info-grid">
          <div class="info-item">
            <span class="label">Name:</span>
            <span class="value">{{ selectedUser.name }}</span>
          </div>
          <div class="info-item">
            <span class="label">Account:</span>
            <span class="value">{{ selectedUser.accountNumber }}</span>
          </div>
          <div class="info-item">
            <span class="label">Current Balance:</span>
            <span class="value">‚Çπ{{ selectedUser.balance | number:'1.2-2' }}</span>
          </div>
          <div class="info-item" *ngIf="amount > 0">
            <span class="label">New Balance:</span>
            <span class="value" [ngClass]="operationType === 'deposit' ? 'positive' : 'negative'">
              ‚Çπ{{ (selectedUser.balance + (operationType === 'deposit' ? amount : -amount)) | number:'1.2-2' }}
            </span>
          </div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="form-actions">
        <button 
          type="button" 
          class="btn-process" 
          [ngClass]="operationType === 'deposit' ? 'btn-deposit' : 'btn-withdrawal'"
          (click)="processDirectTransaction()"
          [disabled]="!selectedUser || amount <= 0 || !description.trim()"
        >
          <i class="fa" [ngClass]="operationType === 'deposit' ? 'fa-plus' : 'fa-minus'"></i>
          {{ operationType === 'deposit' ? 'Deposit' : 'Withdraw' }} ‚Çπ{{ amount | number:'1.2-2' }}
        </button>
        
        <button type="button" class="btn-clear" (click)="clearForm()">
          Clear Form
        </button>
      </div>
      
      <!-- Success/Error Messages -->
      <div class="message success-message" *ngIf="successMessage">
        <i class="fa fa-check-circle"></i>
        {{ successMessage }}
      </div>

      <div class="message error-message" *ngIf="errorMessage">
        <i class="fa fa-exclamation-circle"></i>
        {{ errorMessage }}
      </div>
    </div>
  </div>


  <!-- Deposit/Withdrawal Modal -->
  <div class="modal-overlay" *ngIf="showDepositWithdrawal" (click)="closeDepositWithdrawal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <i class="fa" [ngClass]="operationType === 'deposit' ? 'fa-plus-circle' : 'fa-minus-circle'"></i>
          {{ operationType === 'deposit' ? 'Deposit Money' : 'Withdraw Money' }}
        </h3>
        <button class="close-btn" (click)="closeDepositWithdrawal()">
          <i class="fa fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="selected-user-info">
          <h4>Selected User</h4>
          <div class="user-details">
            <p><strong>Name:</strong> {{ selectedUser?.name }}</p>
            <p><strong>Account:</strong> {{ selectedUser?.accountNumber }}</p>
            <p><strong>Current Balance:</strong> ‚Çπ{{ selectedUser?.balance | number:'1.2-2' }}</p>
          </div>
        </div>

        <form class="transaction-form">
          <div class="form-group">
            <label for="amount">Amount (‚Çπ)</label>
            <input 
              type="number" 
              id="amount" 
              [(ngModel)]="amount" 
              placeholder="Enter amount"
              min="1"
              max="1000000"
              class="form-input"
            >
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea 
              id="description" 
              [(ngModel)]="description" 
              placeholder="Enter transaction description"
              class="form-textarea"
              rows="3"
            ></textarea>
          </div>

          <div class="transaction-summary" *ngIf="amount > 0">
            <h4>Transaction Summary</h4>
            <div class="summary-details">
              <p><strong>Operation:</strong> {{ operationType === 'deposit' ? 'Deposit' : 'Withdrawal' }}</p>
              <p><strong>Amount:</strong> ‚Çπ{{ amount | number:'1.2-2' }}</p>
              <p><strong>Current Balance:</strong> ‚Çπ{{ selectedUser?.balance | number:'1.2-2' }}</p>
              <p><strong>New Balance:</strong> ‚Çπ{{ (selectedUser?.balance || 0) + (operationType === 'deposit' ? amount : -amount) | number:'1.2-2' }}</p>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="closeDepositWithdrawal()">
              Cancel
            </button>
            <button 
              type="button" 
              class="btn-confirm" 
              [ngClass]="operationType === 'deposit' ? 'btn-deposit' : 'btn-withdrawal'"
              (click)="processTransaction()"
              [disabled]="amount <= 0 || !description.trim()"
            >
              <i class="fa" [ngClass]="operationType === 'deposit' ? 'fa-plus' : 'fa-minus'"></i>
              {{ operationType === 'deposit' ? 'Deposit' : 'Withdraw' }} ‚Çπ{{ amount | number:'1.2-2' }}
            </button>
          </div>
        </form>

        <!-- Success/Error Messages -->
        <div class="message success-message" *ngIf="successMessage">
          <i class="fa fa-check-circle"></i>
          {{ successMessage }}
        </div>

        <div class="message error-message" *ngIf="errorMessage">
          <i class="fa fa-exclamation-circle"></i>
          {{ errorMessage }}
        </div>
      </div>
    </div>
  </div>

  <!-- Main Dashboard Cards -->
  <div class="horizontal-dashboard">
    <div class="dash-card" (click)="navigateTo('users')">
      <i class="fa fa-users dash-icon"></i>
      <h3>Manage Users</h3>
      <p>Create, view, and update users</p>
    </div>

    <div class="dash-card" (click)="navigateTo('user-control')" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important; color: white !important;">
      <i class="fa fa-user-cog dash-icon" style="color: white !important;"></i>
      <h3 style="color: white !important;">üîê Full User Control</h3>
      <p style="color: rgba(255,255,255,0.9) !important;">Edit all user details & accounts</p>
    </div>

    <div class="dash-card" (click)="navigateTo('kyc')">
      <i class="fa fa-id-card dash-icon"></i>
      <h3>KYC Verification</h3>
      <p>Approve or reject KYC requests</p>
    </div>

    <div class="dash-card" (click)="navigateTo('cards')">
      <i class="fa fa-credit-card dash-icon"></i>
      <h3>Manage Cards</h3>
      <p>Issue, block, or update cards</p>
    </div>

    <div class="dash-card" (click)="navigateTo('loans')">
      <i class="fa fa-coins dash-icon"></i>
      <h3>Loan Requests</h3>
      <p>Approve or reject loan applications</p>
    </div>

    <div class="dash-card" (click)="navigateTo('transactions')">
      <i class="fa fa-chart-line dash-icon"></i>
      <h3>Transactions</h3>
      <p>View all user transactions</p>
    </div>

    <div class="dash-card foreclosure-card" (click)="navigateTo('loans')" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%) !important; color: white !important;">
      <i class="fa fa-file-invoice-dollar dash-icon" style="color: white !important;"></i>
      <h3 style="color: white !important;">üè¶ Foreclose Loan</h3>
      <p style="color: rgba(255,255,255,0.9) !important;">Process loan foreclosure</p>
    </div>

    <div class="dash-card" (click)="navigateTo('cheques')" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; color: white !important;">
      <i class="fa fa-file-invoice dash-icon" style="color: white !important;"></i>
      <h3 style="color: white !important;">üìù Cheque Management</h3>
      <p style="color: rgba(255,255,255,0.9) !important;">Draw and bounce cheques</p>
    </div>

    <div class="dash-card" (click)="toggleTrackingSection()" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important; color: white !important;">
      <i class="fa fa-search-location dash-icon" style="color: white !important;"></i>
      <h3 style="color: white !important;">üìã Account Tracking</h3>
      <p style="color: rgba(255,255,255,0.9) !important;">Track account creation status</p>
    </div>

  </div>

  <!-- Account Tracking Section -->
  <div class="tracking-section" *ngIf="showTrackingSection">
    <div class="section-header">
      <h3><i class="fa fa-search-location"></i> Account Creation Tracking</h3>
      <button class="close-btn" (click)="toggleTrackingSection()">
        <i class="fa fa-times"></i>
      </button>
    </div>

    <div class="tracking-filters">
      <div class="filter-group">
        <input 
          type="text" 
          [(ngModel)]="trackingSearchQuery" 
          placeholder="Search by Tracking ID, Aadhar, Mobile, or Email..."
          class="search-input"
        >
      </div>
      <div class="filter-group">
        <select [(ngModel)]="trackingStatusFilter" class="status-select">
          <option *ngFor="let option of trackingStatusOptions" [value]="option">
            {{ option === 'ALL' ? 'All Status' : option.replace('_', ' ') }}
          </option>
        </select>
      </div>
      <div class="filter-group">
        <button class="refresh-btn" (click)="loadAccountTrackings()">
          <i class="fa fa-sync-alt"></i> Refresh
        </button>
      </div>
      <div class="filter-group">
        <button class="refresh-btn" (click)="trackByAadharAndMobile()" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
          <i class="fa fa-search"></i> Track by Aadhar & Mobile
        </button>
      </div>
    </div>

    <div class="tracking-table-container">
      <table class="tracking-table">
        <thead>
          <tr>
            <th>Sr. No.</th>
            <th>Tracking ID</th>
            <th>Aadhar Number</th>
            <th>Mobile Number</th>
            <th>User Email</th>
            <th>Status</th>
            <th>Created At</th>
            <th>Last Updated</th>
            <th>Updated By</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tracking of filteredTrackings; let i = index">
            <td>{{ i + 1 }}</td>
            <td><strong>{{ tracking.trackingId }}</strong></td>
            <td>{{ tracking.aadharNumber }}</td>
            <td>{{ tracking.mobileNumber || 'N/A' }}</td>
            <td>{{ tracking.user?.email || 'N/A' }}</td>
            <td>
              <span [class]="getStatusBadgeClass(tracking.status)">
                {{ getStatusLabel(tracking.status) }}
              </span>
            </td>
            <td>{{ tracking.createdAt | date:'short' }}</td>
            <td>{{ tracking.updatedAt | date:'short' }}</td>
            <td>{{ tracking.updatedBy || 'N/A' }}</td>
            <td>
              <div class="action-buttons">
                <select 
                  (change)="updateTrackingStatus(tracking, $any($event.target).value)"
                  [value]="tracking.status"
                  class="status-update-select"
                >
                  <option value="PENDING">Pending</option>
                  <option value="ADMIN_SEEN">Admin Seen</option>
                  <option value="ADMIN_APPROVED">Approved</option>
                  <option value="ADMIN_SENT">Sent</option>
                </select>
              </div>
            </td>
          </tr>
          <tr *ngIf="filteredTrackings.length === 0">
            <td colspan="10" class="no-data">
              <i class="fa fa-info-circle"></i>
              No tracking records found
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="tracking-stats">
      <div class="stat-item">
        <span class="stat-label">Total:</span>
        <span class="stat-value">{{ totalTrackings }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Pending:</span>
        <span class="stat-value">{{ pendingTrackings }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Seen:</span>
        <span class="stat-value">{{ seenTrackings }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Approved:</span>
        <span class="stat-value">{{ approvedTrackings }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Sent:</span>
        <span class="stat-value">{{ sentTrackings }}</span>
      </div>
    </div>
  </div>
</div>
