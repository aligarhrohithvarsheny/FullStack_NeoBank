<div class="loans-container">
  <h2>Loan Applications Management</h2>
  
  <!-- Action Buttons Section -->
  <div class="action-buttons-section">
    <!-- Back to Dashboard Button -->
    <button class="back-btn" (click)="goBack()">‚Üê Back to Dashboard</button>
    
    <!-- Refresh Button -->
    <button class="refresh-btn" (click)="loadAllLoans()">üîÑ Refresh</button>
    
    <!-- Foreclosure Button - Prominent -->
    <button class="foreclosure-btn" (click)="openForeclosureModal()">
      <span class="btn-icon">üè¶</span>
      <span class="btn-text">Foreclose Loan</span>
    </button>
  </div>

  <!-- Loading indicator -->
  <div *ngIf="loading" class="loading">Loading loan applications...</div>

  <!-- Loan Requests Table -->
  <div *ngIf="!loading" class="table-container">
    <table class="loan-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Loan Account</th>
          <th>User Name</th>
          <th>Email</th>
          <th>Account Number</th>
          <th>Child Account</th>
          <th>Current Balance</th>
          <th>Loan Type</th>
          <th>Amount</th>
          <th>Tenure (Months)</th>
          <th>Interest Rate (%)</th>
          <th>Status</th>
          <th>Applied Date</th>
          <th>Approved Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let loan of loanRequests; trackBy: trackByLoanId">
          <td>{{ loan.id }}</td>
          <td>{{ loan.loanAccountNumber }}</td>
          <td>{{ loan.userName }}</td>
          <td>{{ loan.userEmail }}</td>
          <td>
            <div class="account-info">
              <span class="account-number">{{ loan.accountNumber }}</span>
              <span *ngIf="loan.type === 'Education Loan' && loan.childAccountNumber" class="account-badge applicant">Applicant</span>
            </div>
          </td>
          <td>
            <div *ngIf="loan.type === 'Education Loan' && loan.childAccountNumber" class="account-info">
              <span class="account-number">{{ loan.childAccountNumber }}</span>
              <span class="account-badge child">Child</span>
            </div>
            <span *ngIf="!(loan.type === 'Education Loan' && loan.childAccountNumber)">-</span>
          </td>
          <td>{{ loan.currentBalance | currency:'INR' }}</td>
          <td>
            <span>{{ loan.type }}</span>
            <span *ngIf="loan.type === 'Education Loan' && loan.childAccountNumber" class="mapped-badge" title="Mapped to both applicant and child accounts">üîó</span>
          </td>
          <td>{{ loan.amount | currency:'INR' }}</td>
          <td>{{ loan.tenure }}</td>
          <td>{{ loan.interestRate }}</td>
          <td [class.pending]="loan.status === 'Pending'"
              [class.approved]="loan.status === 'Approved'"
              [class.rejected]="loan.status === 'Rejected'"
              [class.foreclosed]="loan.status === 'Foreclosed'">
            {{ loan.status }}
          </td>
          <td>{{ formatDateTime(loan.applicationDate) }}</td>
          <td>{{ loan.approvalDate ? formatDateTime(loan.approvalDate) : '-' }}</td>
          <td>
            <div class="actions">
              <ng-container *ngIf="loan.status === 'Pending'; else processedTemplate">
                <button class="approve-btn" (click)="approve(loan)">Approve</button>
                <button class="reject-btn" (click)="reject(loan)">Reject</button>
              </ng-container>
              <ng-template #processedTemplate>
                <ng-container *ngIf="loan.status === 'Approved'; else alreadyProcessed">
                  <button class="foreclose-action-btn" (click)="forecloseLoanFromTable(loan)">üè¶ Foreclose</button>
                </ng-container>
                <ng-template #alreadyProcessed>
                  <span class="processed">{{ loan.status === 'Foreclosed' ? 'Foreclosed' : 'Processed' }}</span>
                </ng-template>
              </ng-template>

              <!-- View Personal Loan Form (only for Personal Loans) -->
              <button 
                *ngIf="loan.type === 'Personal Loan' && loan.personalLoanFormPath"
                class="view-form-btn" 
                (click)="viewPersonalLoanForm(loan)"
                title="View Uploaded Application Form">
                üìÑ View Form
              </button>

              <!-- EMI per‚Äëmonth payment details (available once loan is approved) -->
              <button 
                class="emi-details-btn" 
                (click)="openEmiDetails(loan)"
                [disabled]="loan.status !== 'Approved' && loan.status !== 'Foreclosed' && loan.status !== 'Paid'">
                üìÖ EMI Details
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    
    <!-- No loans message -->
    <div *ngIf="loanRequests.length === 0" class="no-loans">
      <p>No loan applications found.</p>
    </div>
  </div>

  <!-- Foreclosure Modal -->
  <div class="modal-overlay" *ngIf="showForeclosureModal" (click)="closeForeclosureModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üè¶ Loan Foreclosure</h3>
        <button class="close-btn" (click)="closeForeclosureModal()">√ó</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="loanNumber">Loan Account Number:</label>
          <input 
            type="text" 
            id="loanNumber"
            [(ngModel)]="foreclosureLoanNumber" 
            placeholder="Enter loan account number (e.g., LOAN20240101120000)"
            class="form-input"
            [disabled]="calculatingForeclosure || processingForeclosure"
          />
        </div>

        <div class="error-message" *ngIf="foreclosureError">
          ‚ùå {{ foreclosureError }}
        </div>

        <div class="button-group">
          <button 
            class="calculate-btn" 
            (click)="calculateForeclosure()"
            [disabled]="calculatingForeclosure || processingForeclosure || !foreclosureLoanNumber.trim()">
            <span *ngIf="!calculatingForeclosure">Calculate Foreclosure</span>
            <span *ngIf="calculatingForeclosure">‚è≥ Calculating...</span>
          </button>
        </div>

        <!-- Foreclosure Details -->
        <div class="foreclosure-details" *ngIf="foreclosureDetails">
          <h4>Foreclosure Calculation</h4>
          <div class="details-grid">
            <div class="detail-item">
              <span class="label">Months Elapsed:</span>
              <span class="value">{{ foreclosureDetails.monthsElapsed }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Remaining Months:</span>
              <span class="value">{{ foreclosureDetails.remainingMonths }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Monthly EMI:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.emi | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Total Paid:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.totalPaid | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Principal Paid:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.principalPaid | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Interest Paid:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.interestPaid | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item highlight">
              <span class="label">Remaining Principal:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.remainingPrincipal | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item highlight">
              <span class="label">Remaining Interest:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.remainingInterest | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Foreclosure Charges (4%):</span>
              <span class="value">‚Çπ{{ foreclosureDetails.foreclosureCharges | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">GST (18% on Charges):</span>
              <span class="value">‚Çπ{{ foreclosureDetails.gst | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item total">
              <span class="label">Total Foreclosure Amount:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.totalForeclosureAmount | number:'1.2-2' }}</span>
            </div>
          </div>

          <div class="button-group">
            <button 
              class="process-btn" 
              (click)="processForeclosure()"
              [disabled]="processingForeclosure">
              <span *ngIf="!processingForeclosure">‚úÖ Process Foreclosure</span>
              <span *ngIf="processingForeclosure">‚è≥ Processing...</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EMI Schedule & Payments Modal -->
  <div class="modal-overlay" *ngIf="showEmiModal" (click)="closeEmiModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header emi-header">
        <h3>üìÖ EMI Schedule & Payments</h3>
        <button class="close-btn" (click)="closeEmiModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div *ngIf="selectedLoanForEmi" class="emi-summary">
          <h4>Loan Overview</h4>
          <div class="emi-summary-grid">
            <div class="emi-summary-item">
              <span class="label">Loan Account</span>
              <span class="value">{{ selectedLoanForEmi.loanAccountNumber }}</span>
            </div>
            <div class="emi-summary-item">
              <span class="label">Customer</span>
              <span class="value">{{ selectedLoanForEmi.userName }} ({{ selectedLoanForEmi.userEmail }})</span>
            </div>
            <div class="emi-summary-item">
              <span class="label">Linked Account</span>
              <span class="value">{{ selectedLoanForEmi.accountNumber }}</span>
            </div>
            <div class="emi-summary-item">
              <span class="label">Loan Amount</span>
              <span class="value">{{ selectedLoanForEmi.amount | currency:'INR' }}</span>
            </div>
            <div class="emi-summary-item">
              <span class="label">Tenure</span>
              <span class="value">{{ selectedLoanForEmi.tenure }} months</span>
            </div>
            <div class="emi-summary-item">
              <span class="label">Interest Rate</span>
              <span class="value">{{ selectedLoanForEmi.interestRate }}%</span>
            </div>
          </div>
        </div>

        <div *ngIf="loadingEmis" class="loading">
          Loading EMI schedule...
        </div>

        <div *ngIf="!loadingEmis && emisError" class="error-message">
          ‚ùå {{ emisError }}
        </div>

        <div *ngIf="!loadingEmis && !emisError">
          <div *ngIf="emis.length === 0" class="no-loans">
            <p>No EMI schedule found for this loan.</p>
          </div>

          <div *ngIf="emis.length > 0" class="emi-table-container">
            <table class="emi-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Due Date</th>
                  <th>Status</th>
                  <th>EMI Amount</th>
                  <th>Principal</th>
                  <th>Interest</th>
                  <th>Remaining Principal</th>
                  <th>Payment Date</th>
                  <th>Paid From (Account)</th>
                  <th>Balance Before</th>
                  <th>Balance After</th>
                  <th>Transaction ID</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let emi of emis; trackBy: trackByEmiId">
                  <td>{{ emi.emiNumber }}</td>
                  <td>{{ emi.dueDate | date:'mediumDate' }}</td>
                  <td>
                    <span 
                      class="emi-status" 
                      [ngClass]="{
                        'emi-paid': emi.status === 'Paid',
                        'emi-pending': emi.status === 'Pending',
                        'emi-overdue': emi.status === 'Overdue'
                      }">
                      {{ emi.status }}
                    </span>
                  </td>
                  <td>{{ emi.totalAmount | currency:'INR' }}</td>
                  <td>{{ emi.principalAmount | currency:'INR' }}</td>
                  <td>{{ emi.interestAmount | currency:'INR' }}</td>
                  <td>{{ emi.remainingPrincipal | currency:'INR' }}</td>
                  <td>{{ emi.paymentDate ? formatDateTime(emi.paymentDate) : '-' }}</td>
                  <td>{{ emi.accountNumber }}</td>
                  <td>{{ emi.balanceBeforePayment !== undefined ? (emi.balanceBeforePayment | currency:'INR') : '-' }}</td>
                  <td>{{ emi.balanceAfterPayment !== undefined ? (emi.balanceAfterPayment | currency:'INR') : '-' }}</td>
                  <td>{{ emi.transactionId || '-' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
