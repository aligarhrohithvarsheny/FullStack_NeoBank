<div class="loans-container">
  <h2>Loan Applications Management</h2>
  
  <!-- Action Buttons Section -->
  <div class="action-buttons-section">
    <!-- Back to Dashboard Button -->
    <button class="back-btn" (click)="goBack()">‚Üê Back to Dashboard</button>
    
    <!-- Refresh Button -->
    <button class="refresh-btn" (click)="loadAllLoans()">üîÑ Refresh</button>
    
    <!-- Foreclosure Button - Prominent -->
    <button class="foreclosure-btn" (click)="openForeclosureModal()">
      <span class="btn-icon">üè¶</span>
      <span class="btn-text">Foreclose Loan</span>
    </button>
  </div>

  <!-- Loading indicator -->
  <div *ngIf="loading" class="loading">Loading loan applications...</div>

  <!-- Loan Requests Table -->
  <div *ngIf="!loading" class="table-container">
    <table class="loan-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Loan Account</th>
          <th>User Name</th>
          <th>Email</th>
          <th>Account Number</th>
          <th>Current Balance</th>
          <th>Loan Type</th>
          <th>Amount</th>
          <th>Tenure (Months)</th>
          <th>Interest Rate (%)</th>
          <th>Status</th>
          <th>Applied Date</th>
          <th>Approved Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let loan of loanRequests; trackBy: trackByLoanId">
          <td>{{ loan.id }}</td>
          <td>{{ loan.loanAccountNumber }}</td>
          <td>{{ loan.userName }}</td>
          <td>{{ loan.userEmail }}</td>
          <td>{{ loan.accountNumber }}</td>
          <td>{{ loan.currentBalance | currency:'INR' }}</td>
          <td>{{ loan.type }}</td>
          <td>{{ loan.amount | currency:'INR' }}</td>
          <td>{{ loan.tenure }}</td>
          <td>{{ loan.interestRate }}</td>
          <td [class.pending]="loan.status === 'Pending'"
              [class.approved]="loan.status === 'Approved'"
              [class.rejected]="loan.status === 'Rejected'"
              [class.foreclosed]="loan.status === 'Foreclosed'">
            {{ loan.status }}
          </td>
          <td>{{ loan.applicationDate | date:'short' }}</td>
          <td>{{ loan.approvalDate ? (loan.approvalDate | date:'short') : '-' }}</td>
          <td>
            <ng-container *ngIf="loan.status === 'Pending'; else processedTemplate">
              <button class="approve-btn" (click)="approve(loan)">Approve</button>
              <button class="reject-btn" (click)="reject(loan)">Reject</button>
            </ng-container>
            <ng-template #processedTemplate>
              <ng-container *ngIf="loan.status === 'Approved'; else alreadyProcessed">
                <button class="foreclose-action-btn" (click)="forecloseLoanFromTable(loan)">üè¶ Foreclose</button>
              </ng-container>
              <ng-template #alreadyProcessed>
                <span class="processed">{{ loan.status === 'Foreclosed' ? 'Foreclosed' : 'Processed' }}</span>
              </ng-template>
            </ng-template>
          </td>
        </tr>
      </tbody>
    </table>
    
    <!-- No loans message -->
    <div *ngIf="loanRequests.length === 0" class="no-loans">
      <p>No loan applications found.</p>
    </div>
  </div>

  <!-- Foreclosure Modal -->
  <div class="modal-overlay" *ngIf="showForeclosureModal" (click)="closeForeclosureModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üè¶ Loan Foreclosure</h3>
        <button class="close-btn" (click)="closeForeclosureModal()">√ó</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="loanNumber">Loan Account Number:</label>
          <input 
            type="text" 
            id="loanNumber"
            [(ngModel)]="foreclosureLoanNumber" 
            placeholder="Enter loan account number (e.g., LOAN20240101120000)"
            class="form-input"
            [disabled]="calculatingForeclosure || processingForeclosure"
          />
        </div>

        <div class="error-message" *ngIf="foreclosureError">
          ‚ùå {{ foreclosureError }}
        </div>

        <div class="button-group">
          <button 
            class="calculate-btn" 
            (click)="calculateForeclosure()"
            [disabled]="calculatingForeclosure || processingForeclosure || !foreclosureLoanNumber.trim()">
            <span *ngIf="!calculatingForeclosure">Calculate Foreclosure</span>
            <span *ngIf="calculatingForeclosure">‚è≥ Calculating...</span>
          </button>
        </div>

        <!-- Foreclosure Details -->
        <div class="foreclosure-details" *ngIf="foreclosureDetails">
          <h4>Foreclosure Calculation</h4>
          <div class="details-grid">
            <div class="detail-item">
              <span class="label">Months Elapsed:</span>
              <span class="value">{{ foreclosureDetails.monthsElapsed }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Remaining Months:</span>
              <span class="value">{{ foreclosureDetails.remainingMonths }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Monthly EMI:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.emi | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Total Paid:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.totalPaid | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Principal Paid:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.principalPaid | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Interest Paid:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.interestPaid | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item highlight">
              <span class="label">Remaining Principal:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.remainingPrincipal | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item highlight">
              <span class="label">Remaining Interest:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.remainingInterest | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Foreclosure Charges (4%):</span>
              <span class="value">‚Çπ{{ foreclosureDetails.foreclosureCharges | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">GST (18% on Charges):</span>
              <span class="value">‚Çπ{{ foreclosureDetails.gst | number:'1.2-2' }}</span>
            </div>
            <div class="detail-item total">
              <span class="label">Total Foreclosure Amount:</span>
              <span class="value">‚Çπ{{ foreclosureDetails.totalForeclosureAmount | number:'1.2-2' }}</span>
            </div>
          </div>

          <div class="button-group">
            <button 
              class="process-btn" 
              (click)="processForeclosure()"
              [disabled]="processingForeclosure">
              <span *ngIf="!processingForeclosure">‚úÖ Process Foreclosure</span>
              <span *ngIf="processingForeclosure">‚è≥ Processing...</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
